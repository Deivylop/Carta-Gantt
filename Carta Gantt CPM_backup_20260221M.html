<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Carta Gantt CPM</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;font-family:"Segoe UI",system-ui,sans-serif;font-size:12px;background:#111827;color:#d1d5db}
#app{display:flex;flex-direction:column;height:100vh}

/*  RIBBON TOOLBAR (MS Project style)  */
#ribbon{background:#0f172a;border-bottom:2px solid #1f2937;flex-shrink:0;display:flex;flex-direction:column}
#ribbon-tabs{display:flex;align-items:center;gap:0;background:#0a0f1a;border-bottom:1px solid #1f2937;padding:0 6px;height:28px}
#app-title-ribbon{font-weight:800;color:#a5b4fc;font-size:12px;margin-right:10px;padding:0 8px;letter-spacing:.02em}
.rtab{background:transparent;border:none;color:#6b7280;font-size:11px;font-weight:600;padding:5px 14px;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s}
.rtab:hover{color:#c7d2fe;background:rgba(99,102,241,.08)}
.rtab.active{color:#a5b4fc;border-bottom-color:#6366f1;background:rgba(99,102,241,.12)}
#ribbon-body{display:flex;align-items:stretch;padding:3px 8px;gap:0;min-height:58px;overflow-x:auto;overflow-y:hidden}
.ribbon-panel{display:none;align-items:stretch;gap:0;width:100%}
.ribbon-panel.active{display:flex}
.rgroup{display:flex;flex-direction:column;align-items:center;border-right:1px solid #1f2937;padding:2px 8px;gap:1px;position:relative}
.rgroup:last-child{border-right:none}
.rgroup-title{font-size:8px;text-transform:uppercase;letter-spacing:.06em;color:#475569;font-weight:700;padding-top:1px;white-space:nowrap;text-align:center;margin-top:auto}
.rgroup-body{display:flex;align-items:center;gap:4px;flex:1}
.tb-btn{background:#1f2937;border:1px solid #374151;color:#d1d5db;padding:3px 9px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;line-height:1.3}
.tb-btn:hover{background:#374151}.tb-btn.act{background:#4338ca;border-color:#6366f1;color:#fff}
.tb-btn-big{display:flex;flex-direction:column;align-items:center;gap:1px;background:#1f2937;border:1px solid #374151;color:#d1d5db;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:9px;font-weight:600;white-space:nowrap;min-width:42px}
.tb-btn-big:hover{background:#374151}
.tb-btn-big .rb-icon{font-size:16px;line-height:1}
.tb-sep{width:1px;height:20px;background:#374151;margin:0 2px;flex-shrink:0}
.rlabel{font-size:9px;color:#6b7280;font-weight:600;white-space:nowrap}

/*  MAIN SPLIT: top(gantt) + bottom(form)  */
#main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
#gantt-zone{flex:1;display:flex;overflow:hidden;min-height:0}
#form-zone{height:200px;min-height:80px;background:#0c1220;border-top:3px solid #1f2937;display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
#form-resize{height:4px;background:#1f2937;cursor:row-resize;flex-shrink:0}
#form-resize:hover,#form-resize.rsz{background:#6366f1}

/*  GANTT LEFT (TABLE)  */
#gl-wrap{display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;min-width:300px}
#gl-header{display:flex;background:#0a0f1a;border-bottom:2px solid #1f2937;flex-shrink:0;overflow:hidden}
#gl-body{flex:1;overflow-y:auto;overflow-x:hidden}
.col-hdr{height:36px;line-height:36px;padding:0 5px;font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.04em;border-right:1px solid #1f2937;flex-shrink:0;white-space:nowrap;overflow:hidden;cursor:default;user-select:none;background:#0a0f1a}

/* Table rows */
.trow{display:flex;align-items:stretch;height:26px;border-bottom:1px solid #1a2035;cursor:default;transition:background .08s}
.trow:hover{background:#172040!important}
.trow.sel{background:#1e3058!important}
.trow.empty-row{opacity:.4}
.trow.empty-row:hover{opacity:.7}
.tcell{height:26px;line-height:26px;padding:0 5px;border-right:1px solid #1a2035;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:11px;outline:none;background:transparent}
.tcell:focus{background:#1e293b;outline:1px solid #6366f1;outline-offset:-1px;z-index:1}
.tcell[contenteditable="true"]{cursor:text}
.tcell-num{font-family:monospace;color:#6b7280;text-align:center;font-size:10px}
.tcell-id{font-family:monospace;color:#818cf8}
.tcell-name{color:#e5e7eb}
.tcell-dur{text-align:right;color:#7dd3fc}
.tcell-date{text-align:center;color:#94a3b8;font-size:10px}
.tcell-pred{color:#a78bfa;font-size:10px}
.tcell-pct{text-align:right;color:#6ee7b7}
.tcell-res{color:#f9a8d4;font-size:10px}
.tcell-cal{text-align:center;color:#e5e7eb;font-size:10px}
.trow-summary .tcell.tcell-cal,.trow-task .tcell.tcell-cal{color:#e5e7eb}
.trow-summary .tcell.tcell-cal select,.trow-task .tcell.tcell-cal select{color:#e5e7eb}
.trow-group{background:#1a1040!important;border-bottom:2px solid #4f46e5!important}
.trow-group .tcell{color:#a5b4fc;font-weight:700;font-size:11px;border-right-color:transparent}
.trow-proj{background:#0c0618;border-bottom:2px solid #312e81!important}.trow-proj .tcell-name{font-weight:800;color:#c4b5fd;font-size:12px}.trow-proj .tcell{color:#c4b5fd}
.trow-summary .tcell{font-weight:700;color:#f1f5f9}
.trow-summary .tcell-name{font-size:11.5px}
.trow-task .tcell{font-weight:400;color:#e5e7eb}
.trow-lv0{background:#080d16}
.trow-lv1{background:#0d1422}
.trow-lv2{background:#111827}

/*  COLUMN RESIZE  */
.col-rsz{position:absolute;right:-2px;top:0;bottom:0;width:5px;cursor:col-resize;z-index:2}

/*  GANTT RESIZE (vertical bar between table & chart)  */
#gantt-v-resize{width:4px;background:#1f2937;cursor:col-resize;flex-shrink:0}
#gantt-v-resize:hover,#gantt-v-resize.rsz{background:#6366f1}

/*  GANTT RIGHT (CHART)  */
#gr-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:100px}
#gr-header{height:36px;overflow:hidden;flex-shrink:0;background:#0a0f1a;border-bottom:2px solid #1f2937}
#gr-body{flex:1;overflow:auto;position:relative}
#hdrCanvas,#barCanvas{display:block}

/*  FORM ZONE (bottom panel)  */
#form-header{display:flex;align-items:center;padding:3px 10px;background:#0f172a;border-bottom:1px solid #1f2937;gap:12px;flex-shrink:0;min-height:30px}
#form-header .ftitle{font-weight:700;font-size:12px;color:#f1f5f9;flex-shrink:0}
#form-header .ffields{display:flex;gap:8px;flex-wrap:wrap;align-items:center;flex:1;overflow:hidden}
.ff-lbl{font-size:10px;color:#6b7280;font-weight:600}
.ff-val{font-size:11px;color:#e5e7eb;background:#1f2937;border:1px solid #374151;border-radius:3px;padding:1px 6px;min-width:60px;outline:none}
.ff-val:focus{border-color:#6366f1}
#form-body{flex:1;display:flex;overflow:hidden}
.fp-half{flex:1;display:flex;flex-direction:column;overflow:hidden}
.fp-half+.fp-half{border-left:2px solid #1f2937}
.fp-title{padding:3px 10px;font-size:10px;font-weight:700;color:#059669;text-transform:uppercase;letter-spacing:.05em;background:#0a0f1a;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:6px}
.fp-title-suc{color:#f59e0b}
.fp-table{flex:1;overflow-y:auto;padding:0}
.fp-row{display:flex;align-items:center;height:24px;border-bottom:1px solid #1a2035;font-size:11px;padding:0 6px;gap:6px}
.fp-row:hover{background:#172040}
.fp-hdr{font-weight:700;color:#6b7280;font-size:10px;text-transform:uppercase;background:#0d1422}
.fp-cell{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fp-cell-id{width:70px;flex-shrink:0;font-family:monospace;color:#818cf8}
.fp-cell-name{flex:2}
.fp-cell-type{width:40px;flex-shrink:0;text-align:center;color:#a78bfa}
.fp-cell-lag{width:50px;flex-shrink:0;text-align:center;color:#fbbf24}
.fp-cell-btn{width:24px;flex-shrink:0;text-align:center}
.fp-add-row{display:flex;gap:4px;padding:4px 6px;align-items:center;border-top:1px solid #1f2937;flex-shrink:0;background:#0a0f1a}
.fp-add-row input,.fp-add-row select{background:#1f2937;border:1px solid #374151;color:#e5e7eb;padding:2px 4px;border-radius:3px;font-size:10px;outline:none}
.fp-add-row input:focus,.fp-add-row select:focus{border-color:#6366f1}
.fp-add-btn{background:#059669;color:#fff;border:none;border-radius:3px;padding:2px 8px;font-size:10px;font-weight:700;cursor:pointer}
.fp-add-btn:hover{background:#047857}

/* Form view tabs */
.fv-tabs{display:flex;gap:0;padding:0 6px;background:#0a0f1a;border-bottom:1px solid #1f2937;flex-shrink:0}
.fv-tab{padding:4px 14px;font-size:10px;font-weight:700;color:#6b7280;cursor:pointer;border-bottom:2px solid transparent;text-transform:uppercase;letter-spacing:.03em}
.fv-tab:hover{color:#a5b4fc}
.fv-tab.active{color:#818cf8;border-bottom-color:#818cf8}
.fv-panel{display:none;flex:1;overflow:hidden}
.fv-panel.active{display:flex}

/* RESOURCE SHEET VIEW */
#resource-sheet-view{display:none;flex:1;flex-direction:column;overflow:hidden;background:#111827}
#resource-sheet-view.active{display:flex}
#rs-wrap{flex:1;display:flex;overflow:hidden}
#rs-sidebar{writing-mode:vertical-rl;text-orientation:mixed;background:#1a1040;color:#a5b4fc;font-weight:800;font-size:12px;letter-spacing:.1em;text-transform:uppercase;padding:10px 6px;text-align:center;user-select:none;flex-shrink:0}
#rs-main{flex:1;display:flex;flex-direction:column;overflow:hidden}
#rs-toolbar{display:flex;gap:6px;align-items:center;padding:6px 10px;background:#0f172a;border-bottom:1px solid #1f2937;flex-shrink:0}
#rs-table-wrap{flex:1;overflow:auto;padding:0}
table.rs-table{width:100%;border-collapse:collapse;font-size:11px}
.rs-table th{background:#0a0f1a;color:#6b7280;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;padding:6px 8px;border-bottom:2px solid #1f2937;border-right:1px solid #1f2937;position:sticky;top:0;z-index:1;text-align:left;white-space:nowrap}
.rs-table td{padding:4px 8px;border-bottom:1px solid #1e293b;border-right:1px solid #1e293b;color:#d1d5db;white-space:nowrap}
.rs-table tr:hover td{background:#1e293b}
.rs-table tr.rs-sel td{background:#312e81!important}
.rs-table td[contenteditable="true"]:focus{outline:2px solid #6366f1;outline-offset:-1px;background:#1e293b}
.rs-table .rs-empty td{opacity:.4;font-style:italic}
.rs-table select{background:transparent;border:none;color:inherit;font:inherit;cursor:pointer;outline:none}
body.light #resource-sheet-view{background:#f8fafc}
body.light #rs-sidebar{background:#ede9fe;color:#4338ca}
body.light #rs-toolbar{background:#e2e8f0;border-bottom-color:#cbd5e1}
body.light .rs-table th{background:#f1f5f9;color:#475569;border-bottom-color:#cbd5e1;border-right-color:#e2e8f0}
body.light .rs-table td{border-bottom-color:#e2e8f0;border-right-color:#e2e8f0;color:#1e293b}
body.light .rs-table tr:hover td{background:#e0e7ff}
body.light .rs-table tr.rs-sel td{background:#c7d2fe!important}
body.light .rs-table td[contenteditable="true"]:focus{background:#e0e7ff}

/* Resource panel */
.fp-cell-units{width:60px;flex-shrink:0;text-align:center;color:#34d399}
.fp-cell-work{width:70px;flex-shrink:0;text-align:center;color:#60a5fa}
.fp-title-res{color:#06b6d4}

/* Autocomplete dropdown */
.ac-wrap{position:relative;display:inline-block}
.ac-input{background:#1f2937;border:1px solid #374151;color:#e5e7eb;padding:2px 4px;border-radius:3px;font-size:10px;outline:none;width:100%}
.ac-input:focus{border-color:#6366f1}
.ac-list{display:none;position:absolute;left:0;top:100%;background:#1e293b;border:1px solid #374151;border-radius:0 0 5px 5px;max-height:180px;overflow-y:auto;z-index:2000;width:260px;box-shadow:0 8px 24px rgba(0,0,0,.6)}
.ac-list.open{display:block}
.ac-item{padding:3px 8px;font-size:10px;color:#d1d5db;cursor:pointer;display:flex;gap:6px;align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ac-item:hover,.ac-item.hl{background:#374151;color:#f1f5f9}
.ac-item .ac-id{color:#818cf8;font-family:monospace;min-width:50px}
.ac-item .ac-nm{color:#94a3b8;flex:1;overflow:hidden;text-overflow:ellipsis}
.ac-empty{padding:6px 8px;font-size:10px;color:#4b5563;font-style:italic}

/*  TOOLTIP  */
#tip{position:fixed;background:#0c1220;border:1px solid #334155;border-radius:7px;padding:9px 12px;font-size:11px;color:#e2e8f0;pointer-events:none;z-index:9999;display:none;max-width:300px;line-height:1.8;box-shadow:0 8px 32px rgba(0,0,0,.7)}

/*  MODAL (para proyecto config)  */
#modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:none;align-items:center;justify-content:center}
#modal-overlay.open{display:flex}
#modal{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:20px;width:480px;max-width:95vw;max-height:90vh;overflow-y:auto}
#modal h2{font-size:14px;font-weight:700;color:#f1f5f9;margin-bottom:14px}
.form-group{margin-bottom:10px}
.form-label{display:block;font-size:10px;font-weight:600;color:#6b7280;margin-bottom:3px;text-transform:uppercase}
.form-input{width:100%;background:#1f2937;border:1px solid #374151;color:#e5e7eb;padding:5px 8px;border-radius:5px;font-size:11px;outline:none}
.form-input:focus{border-color:#6366f1}
.form-row{display:flex;gap:8px}.form-row .form-group{flex:1}
.btn{padding:5px 12px;border-radius:5px;border:none;cursor:pointer;font-size:11px;font-weight:600}
.btn-primary{background:#4f46e5;color:#fff}.btn-primary:hover{background:#4338ca}
.btn-danger{background:#dc2626;color:#fff}.btn-danger:hover{background:#b91c1c}
.btn-success{background:#059669;color:#fff}.btn-success:hover{background:#047857}
.btn-ghost{background:#1f2937;border:1px solid #374151;color:#9ca3af}.btn-ghost:hover{background:#374151;color:#e5e7eb}

/*  LEGEND  */
.legend-item{display:flex;align-items:center;gap:3px;font-size:10px;color:#4b5563}
.legend-box{width:12px;height:7px;border-radius:2px;display:inline-block}

/*  SCROLLBAR  */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#0f172a}
::-webkit-scrollbar-thumb{background:#374151;border-radius:3px}

/* Column context menu */
#col-ctx-menu{position:fixed;background:#1e293b;border:1px solid #374151;border-radius:6px;padding:4px 0;z-index:9999;display:none;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,.7);max-height:400px;overflow-y:auto}
#col-ctx-menu .ctx-item{display:flex;align-items:center;gap:6px;padding:4px 12px;font-size:11px;color:#d1d5db;cursor:pointer;white-space:nowrap}
#col-ctx-menu .ctx-item:hover{background:#374151}
#col-ctx-menu .ctx-item input[type="checkbox"]{accent-color:#6366f1}
#col-ctx-menu .ctx-sep{height:1px;background:#374151;margin:4px 0}

/* Column drag reorder */
.col-hdr.col-dragging{opacity:.4;background:#1e293b}
.col-hdr.col-drag-over{border-left:3px solid #818cf8!important}
.col-hdr.col-drag-over-right{border-right:3px solid #818cf8!important}

/* Editable fp cells */
.fp-cell-edit{outline:none;background:transparent;border:1px solid transparent;border-radius:2px;padding:0 3px;color:inherit;font:inherit;min-width:0}
.fp-cell-edit:hover{border-color:#374151}
.fp-cell-edit:focus{border-color:#6366f1;background:#1e293b}
select.fp-cell-edit{appearance:none;-webkit-appearance:none;cursor:pointer;padding-right:2px}
.fp-cell-edit option{background:#1f2937}

/* Info button in rows */
.tcell-info{width:24px;text-align:center;cursor:pointer;color:#4b5563;font-size:13px;flex-shrink:0}
.tcell-info:hover{color:#818cf8}

/* Activity modal */
#act-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;display:none;align-items:center;justify-content:center}
#act-modal-overlay.open{display:flex}
#act-modal{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:20px;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto}
#act-modal h2{font-size:14px;font-weight:700;color:#f1f5f9;margin-bottom:14px;display:flex;align-items:center;gap:8px}
#act-modal h2 .act-type-badge{font-size:10px;padding:2px 8px;border-radius:9999px;font-weight:600}

/*  EMPTY  */
#empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#374151;gap:8px;pointer-events:none}
#empty-state svg{opacity:.3}
#empty-state p{font-size:13px;color:#4b5563}

/* ═══════════════ LIGHT THEME ═══════════════ */
body.light{background:#f8fafc;color:#1e293b}
body.light #ribbon{background:#e2e8f0;border-bottom-color:#cbd5e1}
body.light #ribbon-tabs{background:#dde3ed;border-bottom-color:#cbd5e1}
body.light #app-title-ribbon{color:#4338ca}
body.light .rtab{color:#64748b}
body.light .rtab:hover{color:#4338ca;background:rgba(99,102,241,.08)}
body.light .rtab.active{color:#4338ca;border-bottom-color:#6366f1;background:rgba(99,102,241,.1)}
body.light .rgroup{border-right-color:#cbd5e1}
body.light .rgroup-title{color:#94a3b8}
body.light .tb-btn{background:#fff;border-color:#cbd5e1;color:#334155}
body.light .tb-btn:hover{background:#e2e8f0}
body.light .tb-btn.act{background:#4338ca;border-color:#6366f1;color:#fff}
body.light .tb-btn-big{background:#fff;border-color:#cbd5e1;color:#334155}
body.light .tb-btn-big:hover{background:#e2e8f0}
body.light .tb-sep{background:#cbd5e1}
body.light .rlabel{color:#64748b}
body.light #form-zone{background:#f1f5f9;border-top-color:#cbd5e1}
body.light #form-resize{background:#cbd5e1}
body.light #form-resize:hover,body.light #form-resize.rsz{background:#6366f1}
body.light #gl-wrap{background:#fff}
body.light #gl-header{background:#f1f5f9;border-bottom-color:#cbd5e1}
body.light .col-hdr{background:#f1f5f9;color:#475569;border-right-color:#e2e8f0}
body.light #gl-body{background:#fff}
body.light .trow{border-bottom-color:#e2e8f0}
body.light .trow:hover{background:#e0e7ff!important}
body.light .trow.sel{background:#c7d2fe!important}
body.light .trow.empty-row{opacity:.3}
body.light .tcell{border-right-color:#e2e8f0}
body.light .tcell:focus{background:#e0e7ff;outline-color:#6366f1}
body.light .tcell-num{color:#64748b}
body.light .tcell-id{color:#4f46e5}
body.light .tcell-name{color:#1e293b}
body.light .tcell-dur{color:#0369a1}
body.light .tcell-date{color:#475569}
body.light .tcell-pred{color:#7c3aed}
body.light .tcell-pct{color:#059669}
body.light .tcell-res{color:#be185d}
body.light .tcell-cal{color:#1e293b}
body.light .trow-summary .tcell.tcell-cal,body.light .trow-task .tcell.tcell-cal{color:#1e293b}
body.light .trow-summary .tcell.tcell-cal select,body.light .trow-task .tcell.tcell-cal select{color:#1e293b}
body.light .trow-group{background:#ede9fe!important;border-bottom-color:#818cf8!important}
body.light .trow-group .tcell{color:#4338ca}
body.light .trow-proj{background:#ede9fe;border-bottom-color:#a78bfa!important}
body.light .trow-proj .tcell-name{color:#4c1d95}
body.light .trow-proj .tcell{color:#5b21b6}
body.light .trow-summary .tcell{font-weight:700;color:#0f172a}
body.light .trow-task .tcell{font-weight:400;color:#1e293b}
body.light .trow-lv0{background:#f8fafc}
body.light .trow-lv1{background:#f1f5f9}
body.light .trow-lv2{background:#fff}
body.light #gantt-v-resize{background:#cbd5e1}
body.light #gantt-v-resize:hover,body.light #gantt-v-resize.rsz{background:#6366f1}
body.light #gr-wrap{background:#fff}
body.light #gr-header{background:#f1f5f9;border-bottom-color:#cbd5e1}
body.light #form-header{background:#e2e8f0;border-bottom-color:#cbd5e1}
body.light #form-header .ftitle{color:#0f172a}
body.light .ff-lbl{color:#475569}
body.light .ff-val{color:#1e293b;background:#fff;border-color:#cbd5e1}
body.light .ff-val:focus{border-color:#6366f1}
body.light .fp-title{background:#f1f5f9;border-bottom-color:#e2e8f0;color:#059669}
body.light .fp-half+.fp-half{border-left-color:#e2e8f0}
body.light .fp-row{border-bottom-color:#e2e8f0}
body.light .fp-row:hover{background:#e0e7ff}
body.light .fp-hdr{background:#f8fafc;color:#475569}
body.light .fp-cell-id{color:#4f46e5}
body.light .fp-cell-type{color:#7c3aed}
body.light .fp-cell-lag{color:#b45309}
body.light .fp-add-row{background:#f1f5f9;border-top-color:#e2e8f0}
body.light .fp-add-row input,body.light .fp-add-row select{background:#fff;border-color:#cbd5e1;color:#1e293b}
body.light .fv-tabs{background:#f1f5f9;border-bottom-color:#e2e8f0}
body.light .fv-tab{color:#64748b}
body.light .fv-tab:hover{color:#4f46e5}
body.light .fv-tab.active{color:#4f46e5;border-bottom-color:#4f46e5}
body.light .ac-input{background:#fff;border-color:#cbd5e1;color:#1e293b}
body.light .ac-list{background:#fff;border-color:#cbd5e1;box-shadow:0 8px 24px rgba(0,0,0,.15)}
body.light .ac-item{color:#334155}
body.light .ac-item:hover,body.light .ac-item.hl{background:#e0e7ff;color:#1e293b}
body.light .ac-item .ac-id{color:#4f46e5}
body.light .ac-item .ac-nm{color:#64748b}
body.light #tip{background:#fff;border-color:#cbd5e1;color:#1e293b;box-shadow:0 8px 32px rgba(0,0,0,.15)}
body.light #modal-overlay{background:rgba(0,0,0,.3)}
body.light #modal{background:#fff;border-color:#e2e8f0}
body.light #modal h2{color:#0f172a}
body.light .form-label{color:#475569}
body.light .form-input{background:#f8fafc;border-color:#cbd5e1;color:#1e293b}
body.light .btn-ghost{background:#f1f5f9;border-color:#cbd5e1;color:#475569}
body.light .btn-ghost:hover{background:#e2e8f0;color:#1e293b}
body.light #act-modal-overlay{background:rgba(0,0,0,.3)}
body.light #act-modal{background:#fff;border-color:#e2e8f0}
body.light #act-modal h2{color:#0f172a}
body.light #col-ctx-menu{background:#fff;border-color:#e2e8f0;box-shadow:0 8px 24px rgba(0,0,0,.12)}
body.light #col-ctx-menu .ctx-item{color:#334155}
body.light #col-ctx-menu .ctx-item:hover{background:#e0e7ff}
body.light .col-hdr.col-dragging{opacity:.4;background:#e0e7ff}
body.light .fp-cell-edit:focus{background:#e0e7ff}
body.light .fp-cell-edit option{background:#fff}
body.light .tcell-info{color:#94a3b8}
body.light .tcell-info:hover{color:#4f46e5}
body.light .legend-item{color:#64748b}
body.light #app-title{color:#0f172a!important}
body.light ::-webkit-scrollbar-track{background:#f1f5f9}
body.light ::-webkit-scrollbar-thumb{background:#cbd5e1}
body.light #link-modal-overlay{background:rgba(0,0,0,.2)}
body.light #link-modal{background:#fff;border-color:#e2e8f0}
body.light #link-modal h2{color:#0f172a}
</style>
</head>
<body>
<div id="app">

<!-- RIBBON (MS Project style) -->
<div id="ribbon">
  <!-- Tab bar -->
  <div id="ribbon-tabs">
    <span id="app-title-ribbon">&#127959; Carta Gantt CPM</span>
    <button class="rtab active" data-panel="panel-tarea" onclick="switchRibbonTab(this)">Tarea</button>
    <button class="rtab" data-panel="panel-proyecto" onclick="switchRibbonTab(this)">Proyecto</button>
    <button class="rtab" data-panel="panel-vista" onclick="switchRibbonTab(this)">Vista</button>
    <button class="rtab" data-panel="panel-datos" onclick="switchRibbonTab(this)">Datos</button>
  </div>
  <!-- Ribbon body -->
  <div id="ribbon-body">

    <!-- ====== TAREA ====== -->
    <div class="ribbon-panel active" id="panel-tarea">
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn-big" onclick="addNewRow()"><span class="rb-icon">➕</span>Actividad</button>
          <button class="tb-btn-big" onclick="addSummaryRow()"><span class="rb-icon">&#128194;</span>Resumen</button>
          <button class="tb-btn-big" onclick="addMilestone()"><span class="rb-icon">&#9670;</span>Hito</button>
          <button class="tb-btn-big" onclick="deleteSelected()"><span class="rb-icon">&#128465;</span>Eliminar</button>
        </div>
        <span class="rgroup-title">Insertar</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn" onclick="indentRow(1)" title="Aumentar sangría">&#8594; Indentar</button>
          <button class="tb-btn" onclick="indentRow(-1)" title="Disminuir sangría">&#8592; Des-indentar</button>
        </div>
        <span class="rgroup-title">Esquema</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body" style="flex-direction:column;gap:2px;align-items:stretch">
          <div style="display:flex;gap:3px">
            <button class="tb-btn" onclick="moveRow(-1)" title="Mover arriba">&#9650;</button>
            <button class="tb-btn" onclick="moveRow(1)" title="Mover abajo">&#9660;</button>
          </div>
          <div style="display:flex;gap:3px">
            <button class="tb-btn" id="btn-cut" onclick="cutActivity()" title="Cortar">&#9986; Cortar</button>
            <button class="tb-btn" id="btn-paste" onclick="pasteActivity()" title="Pegar" disabled>&#128203; Pegar</button>
          </div>
        </div>
        <span class="rgroup-title">Edición</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn-big" onclick="showActModal()" title="Información de actividad"><span class="rb-icon">&#9432;</span>Info</button>
          <button class="tb-btn-big" onclick="undoAction()"><span class="rb-icon">&#8630;</span>Deshacer</button>
        </div>
        <span class="rgroup-title">Propiedades</span>
      </div>
    </div>

    <!-- ====== PROYECTO ====== -->
    <div class="ribbon-panel" id="panel-proyecto">
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn-big" onclick="showProjectModal()"><span class="rb-icon">&#9881;</span>Proyecto</button>
        </div>
        <span class="rgroup-title">Información</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn" onclick="calcCPM()" title="Recalcular CPM" style="background:#4338ca;color:#fff;border-color:#6366f1">&#9654; Calcular</button>
        </div>
        <span class="rgroup-title">Programación</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body" style="gap:6px">
          <span class="rlabel">Status Date:</span>
          <input type="date" id="tb-status-date" class="ff-val" style="width:118px;font-size:10px" onchange="statusDate=parseDate(this.value)||new Date();drawHeader();drawBars();" title="Fecha de Corte"/>
        </div>
        <span class="rgroup-title">Fecha de Corte</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn-big" onclick="saveBaseline()" title="Guardar Línea Base"><span class="rb-icon">&#128190;</span>Línea Base</button>
        </div>
        <span class="rgroup-title">Línea Base</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn act" id="btn-edt0" onclick="toggleProjRow()" title="Mostrar/Ocultar EDT 0">EDT 0</button>
        </div>
        <span class="rgroup-title">Resumen</span>
      </div>
    </div>

    <!-- ====== VISTA ====== -->
    <div class="ribbon-panel" id="panel-vista">
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn-big act" id="btn-view-gantt" onclick="switchMainView('gantt')"><span class="rb-icon">&#128202;</span>Diagrama<br>de Gantt</button>
          <button class="tb-btn-big" id="btn-view-resources" onclick="switchMainView('resources')"><span class="rb-icon">&#128101;</span>Hoja de<br>Recursos</button>
        </div>
        <span class="rgroup-title">Vistas</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body" style="gap:4px">
          <span class="rlabel">Zoom:</span>
          <button class="tb-btn" id="bDay" onclick="setZoom('day')">Día</button>
          <button class="tb-btn act" id="bWeek" onclick="setZoom('week')">Semana</button>
          <button class="tb-btn" id="bMonth" onclick="setZoom('month')">Mes</button>
        </div>
        <span class="rgroup-title">Zoom</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn" onclick="goToday()">&#128197; Hoy</button>
        </div>
        <span class="rgroup-title">Navegar</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <button class="tb-btn" id="btn-theme" onclick="toggleTheme()" title="Cambiar tema">&#9728; Claro</button>
        </div>
        <span class="rgroup-title">Tema</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body" style="gap:6px">
          <span class="rlabel">Agrupar:</span>
          <select class="ff-val" id="tb-group" style="width:140px;font-size:10px" onchange="setGrouping(this.value)" title="Agrupar actividades">
            <option value="none">Sin agrupación</option>
            <option value="critical">Actividades Críticas</option>
            <option value="inprogress">En Ejecución</option>
            <option value="notstarted">No Iniciadas</option>
            <option value="completed">Completadas</option>
            <option value="txt1">Texto 1</option>
            <option value="txt2">Texto 2</option>
            <option value="txt3">Texto 3</option>
            <option value="txt4">Texto 4</option>
            <option value="txt5">Texto 5</option>
          </select>
        </div>
        <span class="rgroup-title">Agrupar</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body">
          <select class="ff-val" id="tb-outline-collapse" style="width:105px;font-size:10px" onchange="collapseToOutline(parseInt(this.value))" title="Colapsar a nivel">
            <option value="-1">Expandir Todo</option>
            <option value="0">Nivel 1</option>
            <option value="1">Nivel 2</option>
            <option value="2">Nivel 3</option>
            <option value="3">Nivel 4</option>
            <option value="4">Nivel 5</option>
          </select>
        </div>
        <span class="rgroup-title">Esquema</span>
      </div>
    </div>

    <!-- ====== DATOS ====== -->
    <div class="ribbon-panel" id="panel-datos">
      <div class="rgroup">
        <div class="rgroup-body" style="flex-direction:column;gap:2px;align-items:stretch">
          <div style="display:flex;gap:3px">
            <button class="tb-btn" onclick="exportJSON()">&#11015; JSON</button>
            <button class="tb-btn" onclick="importJSON()">&#11014; JSON</button>
          </div>
          <div style="display:flex;gap:3px">
            <button class="tb-btn" onclick="exportCSV()">&#11015; CSV</button>
            <button class="tb-btn" onclick="importCSV()">&#11014; CSV</button>
          </div>
        </div>
        <span class="rgroup-title">Importar / Exportar</span>
      </div>
      <div class="rgroup">
        <div class="rgroup-body" style="flex-direction:column;gap:2px;align-items:stretch">
          <div style="display:flex;gap:3px">
            <button class="tb-btn" onclick="sbForceSave()" title="Forzar guardado en la nube">&#9729; Guardar</button>
            <button class="tb-btn" onclick="sbShowLoad()" title="Cargar otro proyecto">&#128194; Cargar</button>
          </div>
          <div style="display:flex;gap:3px;align-items:center">
            <span id="sb-sync-status" style="font-size:10px;color:#4ade80">&#9679; Conectado</span>
          </div>
        </div>
        <span class="rgroup-title">Supabase Cloud</span>
      </div>
    </div>

    <!-- LEYENDA (siempre visible, fuera de paneles) -->
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;padding:0 10px;flex-shrink:0">
      <span class="legend-item"><span class="legend-box" style="background:#ef4444"></span>Crítica</span>
      <span class="legend-item"><span class="legend-box" style="background:#3b82f6"></span>Normal</span>
      <span class="legend-item"><span style="width:8px;height:8px;background:#fbbf24;transform:rotate(45deg);display:inline-block"></span>Hito</span>
      <span class="legend-item"><span style="width:2px;height:12px;background:#f59e0b;display:inline-block"></span>Hoy</span>
      <span class="legend-item"><span class="legend-box" style="background:#22c55e;opacity:.7"></span>Avance</span>
      <span class="legend-item"><span style="width:2px;height:12px;background:#06b6d4;display:inline-block"></span>Status Date</span>
      <span class="legend-item"><span class="legend-box" style="background:#6b7280;opacity:.6"></span>Línea Base</span>
    </div>

  </div>
</div>
<input type="file" id="jsonFile" accept=".json" style="display:none" onchange="loadJSON(this)"/>
<input type="file" id="csvFile" accept=".csv" style="display:none" onchange="loadCSV(this)"/>

<!-- MAIN -->
<div id="main-area">
  <!-- GANTT ZONE (top) -->
  <div id="gantt-zone">
    <!-- LEFT: editable table -->
    <div id="gl-wrap">
      <div id="gl-header"></div>
      <div id="gl-body"></div>
    </div>
    <div id="gantt-v-resize"></div>
    <!-- RIGHT: chart -->
    <div id="gr-wrap">
      <div id="gr-header"><canvas id="hdrCanvas"></canvas></div>
      <div id="gr-body">
        <canvas id="barCanvas"></canvas>
        <div id="empty-state">
          <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/><path d="M8 14h2M12 14h4M8 17h2M12 17h4"/></svg>
          <p>Escribe en la tabla para agregar actividades</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FORM RESIZE -->
  <div id="form-resize"></div>

  <!-- FORM ZONE (bottom) like MS Project task form -->
  <div id="form-zone">
    <div id="form-header">
      <span class="ftitle" id="fh-title">Selecciona una actividad</span>
      <div class="ffields" id="fh-fields">
        <span class="ff-lbl">Nombre:</span><input class="ff-val" id="fh-name" style="width:180px" onchange="formFieldChange('name',this.value)"/>
        <span class="ff-lbl">Duración:</span><input class="ff-val" id="fh-dur" style="width:50px" type="number" min="0" onchange="formFieldChange('dur',this.value)"/>
        <span class="ff-lbl">% completado:</span><input class="ff-val" id="fh-pct" style="width:40px" type="number" min="0" max="100" onchange="formFieldChange('pct',this.value)"/>
        <span class="ff-lbl">Tipo tarea:</span>
        <select class="ff-val" id="fh-type" style="width:90px" onchange="formFieldChange('type',this.value)">
          <option value="task">Tarea</option>
          <option value="milestone">Hito</option>
          <option value="summary">Resumen</option>
        </select>
        <span class="ff-lbl">Comienzo:</span><input class="ff-val" id="fh-start" type="date" style="width:120px" onchange="formFieldChange('startDate',this.value)"/>
        <span class="ff-lbl">Fin:</span><input class="ff-val" id="fh-end" type="date" style="width:120px" readonly title="Calculado por CPM"/>
        <label style="font-size:10px;color:#6b7280;display:flex;align-items:center;gap:3px;cursor:pointer">
          <input type="checkbox" id="fh-manual" onchange="formFieldChange('manual',this.checked)"/>
          Programada manualmente
        </label>
        <button class="tb-btn" onclick="prevActivity()" style="padding:2px 8px">Anterior</button>
        <button class="tb-btn" onclick="nextActivity()" style="padding:2px 8px">Siguiente</button>
      </div>
    </div>
    <div id="form-body">
      <!-- VIEW TABS -->
      <div style="display:flex;flex-direction:column;flex:1;overflow:hidden">
        <div class="fv-tabs">
          <div class="fv-tab active" data-panel="predsuc" onclick="switchFormTab('predsuc')">&#128279; Predecesoras / Sucesoras</div>
          <div class="fv-tab" data-panel="resources" onclick="switchFormTab('resources')">&#128100; Recursos</div>
        </div>

        <!-- PRED/SUC PANEL -->
        <div class="fv-panel active" id="panel-predsuc" style="display:flex">
          <!-- PREDECESORAS -->
          <div class="fp-half">
            <div class="fp-title">&#9654; PREDECESORAS</div>
            <div class="fp-row fp-hdr">
              <div class="fp-cell fp-cell-id">ID</div>
              <div class="fp-cell fp-cell-name">NOMBRE DE LA PREDECESORA</div>
              <div class="fp-cell fp-cell-type">TIPO</div>
              <div class="fp-cell fp-cell-lag">RETARDO</div>
              <div class="fp-cell fp-cell-btn"></div>
            </div>
            <div class="fp-table" id="pred-list"></div>
            <div class="fp-add-row" id="pred-add">
              <div class="ac-wrap" style="flex:1">
                <input class="ac-input" id="pa-id" placeholder="-- ID --" autocomplete="off" onfocus="acOpen('pa')" oninput="acFilter('pa')" onkeydown="acKey(event,'pa')" onblur="acClose('pa')"/>
                <div class="ac-list" id="pa-list"></div>
              </div>
              <select id="pa-type" style="width:44px"><option>FS</option><option>SS</option><option>FF</option><option>SF</option></select>
              <input id="pa-lag" type="number" value="0" style="width:40px" placeholder="Lag"/>
              <button class="fp-add-btn" onclick="addPredFromForm()">+</button>
            </div>
          </div>
          <!-- SUCESORAS -->
          <div class="fp-half">
            <div class="fp-title fp-title-suc">&#9654; SUCESORAS</div>
            <div class="fp-row fp-hdr">
              <div class="fp-cell fp-cell-id">ID</div>
              <div class="fp-cell fp-cell-name">NOMBRE DE LA SUCESORA</div>
              <div class="fp-cell fp-cell-type">TIPO</div>
              <div class="fp-cell fp-cell-lag">RETARDO</div>
              <div class="fp-cell fp-cell-btn"></div>
            </div>
            <div class="fp-table" id="suc-list"></div>
            <div class="fp-add-row" id="suc-add">
              <div class="ac-wrap" style="flex:1">
                <input class="ac-input" id="sa-id" placeholder="-- ID --" autocomplete="off" onfocus="acOpen('sa')" oninput="acFilter('sa')" onkeydown="acKey(event,'sa')" onblur="acClose('sa')"/>
                <div class="ac-list" id="sa-list"></div>
              </div>
              <select id="sa-type" style="width:44px"><option>FS</option><option>SS</option><option>FF</option><option>SF</option></select>
              <input id="sa-lag" type="number" value="0" style="width:40px" placeholder="Lag"/>
              <button class="fp-add-btn" onclick="addSucFromForm()">+</button>
            </div>
          </div>
        </div>

        <!-- RESOURCES PANEL -->
        <div class="fv-panel" id="panel-resources">
          <div class="fp-half" style="flex:1;max-width:100%">
            <div class="fp-title fp-title-res">&#128100; FORMULARIO DE RECURSOS</div>
            <div class="fp-row fp-hdr">
              <div class="fp-cell fp-cell-id">Id</div>
              <div class="fp-cell fp-cell-name">Nombre del recurso</div>
              <div class="fp-cell fp-cell-units">Unidades</div>
              <div class="fp-cell fp-cell-work">Trabajo</div>
              <div class="fp-cell fp-cell-btn"></div>
            </div>
            <div class="fp-table" id="res-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div><!-- /form-zone -->

<!-- RESOURCE SHEET VIEW -->
<div id="resource-sheet-view">
  <div id="rs-wrap">
    <div id="rs-sidebar">Hoja de Recursos</div>
    <div id="rs-main">
      <div id="rs-toolbar">
        <button class="tb-btn" onclick="addPoolResource()">+ Recurso</button>
        <button class="tb-btn" onclick="deletePoolResource()">&#128465; Eliminar</button>
      </div>
      <div id="rs-table-wrap">
        <table class="rs-table" id="rs-table">
          <thead><tr>
            <th style="width:24px">&#9432;</th>
            <th style="width:50px">ID</th>
            <th style="width:180px">Nombre del recurso</th>
            <th style="width:80px">Tipo</th>
            <th style="width:120px">Etiqueta de material</th>
            <th style="width:65px">Iniciales</th>
            <th style="width:80px">Grupo</th>
            <th style="width:90px">Capacidad máx.</th>
            <th style="width:95px">Tasa estándar</th>
            <th style="width:95px">Tasa hora extra</th>
            <th style="width:80px">Costo/Uso</th>
            <th style="width:80px">Acumular</th>
            <th style="width:85px">Calendario base</th>
            <th style="width:70px">Código</th>
          </tr></thead>
          <tbody id="rs-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div><!-- /main-area -->
</div><!-- /app -->

<!-- TOOLTIP -->
<div id="tip"></div>

<!-- SUPABASE LOAD MODAL -->
<div id="sb-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1100;display:none;align-items:center;justify-content:center">
<div style="background:#1e293b;border:1px solid #334155;border-radius:10px;padding:22px;width:420px;max-width:92vw;box-shadow:0 12px 40px rgba(0,0,0,.6)">
  <h2 style="font-size:14px;font-weight:700;color:#a5b4fc;margin-bottom:14px">&#128194; Cargar Proyecto desde la Nube</h2>
  <div id="sb-load-status" style="color:#94a3b8;font-size:11px;margin:6px 0">Cargando...</div>
  <div id="sb-project-list" style="max-height:280px;overflow-y:auto;margin:8px 0"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button onclick="sbCloseModal()" style="padding:6px 14px;background:#334155;color:#d1d5db;border:none;border-radius:4px;cursor:pointer">Cancelar</button>
    <button onclick="sbDeleteProject()" style="padding:6px 14px;background:#dc2626;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600">&#128465; Eliminar</button>
    <button onclick="sbLoadProject()" style="padding:6px 14px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600">&#11014; Cargar</button>
  </div>
</div>
</div>

<!-- COLUMN CONTEXT MENU -->
<div id="col-ctx-menu"></div>

<!-- LINK TYPE MODAL -->
<div id="link-modal-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1001;display:none;align-items:center;justify-content:center">
<div id="link-modal" style="background:#1e293b;border:1px solid #334155;border-radius:10px;padding:18px;width:340px;max-width:90vw;box-shadow:0 12px 40px rgba(0,0,0,.6)">
  <h2 id="lm-title" style="font-size:13px;font-weight:700;color:#f1f5f9;margin-bottom:12px">&#128279; Nueva Vinculación</h2>
  <div style="display:flex;gap:8px;margin-bottom:10px;font-size:11px;color:#94a3b8">
    <span>Desde: <b style="color:#818cf8" id="lm-from"></b></span>
    <span>&#8594;</span>
    <span>Hacia: <b style="color:#6ee7b7" id="lm-to"></b></span>
  </div>
  <div class="form-row" style="margin-bottom:12px">
    <div class="form-group"><label class="form-label">Tipo de Relación</label>
      <select class="form-input" id="lm-type">
        <option value="FS">FS – Fin a Comienzo</option>
        <option value="SS">SS – Comienzo a Comienzo</option>
        <option value="FF">FF – Fin a Fin</option>
        <option value="SF">SF – Comienzo a Fin</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Lag (días)</label>
      <input class="form-input" type="number" id="lm-lag" value="0" style="width:70px"/>
    </div>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="lm-delete" class="btn" style="background:#dc2626;color:#fff;display:none;margin-right:auto" onclick="closeLinkModal('delete')">Eliminar</button>
    <button class="btn btn-ghost" onclick="closeLinkModal(false)">Cancelar</button>
    <button class="btn btn-primary" onclick="closeLinkModal(true)">Guardar</button>
  </div>
</div>
</div>

<!-- ACTIVITY DETAIL MODAL -->
<div id="act-modal-overlay">
<div id="act-modal">
  <h2 id="am-title">Información de Actividad <span class="act-type-badge" id="am-badge"></span></h2>
  <div class="form-row">
    <div class="form-group"><label class="form-label">Activity ID</label><input class="form-input" id="am-id" readonly style="opacity:.7"/></div>
    <div class="form-group"><label class="form-label">WBS / Nivel</label>
      <select class="form-input" id="am-lv"><option value="0">Nivel 0 (Raíz)</option><option value="1">Nivel 1</option><option value="2">Nivel 2</option><option value="3">Nivel 3</option><option value="4">Nivel 4</option><option value="5">Nivel 5</option></select>
    </div>
  </div>
  <div class="form-group"><label class="form-label">Nombre de la Actividad</label><input class="form-input" id="am-name"/></div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">Tipo de tarea</label>
      <select class="form-input" id="am-type"><option value="task">Tarea</option><option value="milestone">Hito (0 días)</option><option value="summary">Resumen</option></select>
    </div>
    <div class="form-group"><label class="form-label">Duración (días háb.)</label><input class="form-input" type="number" id="am-dur" min="0"/></div>
    <div class="form-group"><label class="form-label">Dur. Restante</label><input class="form-input" type="number" id="am-remdur" min="0"/></div>
    <div class="form-group"><label class="form-label">Calendario</label>
      <select class="form-input" id="am-cal"><option value="5">5d (Lun-Vie)</option><option value="6">6d (Lun-Sáb)</option><option value="7">7d (continuo)</option></select>
    </div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">% Avance</label><input class="form-input" type="number" id="am-pct" min="0" max="100"/></div>
    <div class="form-group"><label class="form-label">Recursos</label><input class="form-input" id="am-res"/></div>
    <div class="form-group"><label class="form-label">Trabajo (hrs)</label><input class="form-input" type="number" id="am-work" min="0" step="0.5"/></div>
    <div class="form-group"><label class="form-label">Peso Ponderado (valor absoluto)</label><input class="form-input" type="number" id="am-weight" min="0" step="0.1" placeholder="Auto (=Trabajo)"/><span style="font-size:9px;color:#6b7280;margin-top:2px;display:block">Vacío = auto (usa Trabajo). Se muestra como % de hermanos.</span></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">Restricción</label>
      <select class="form-input" id="am-constraint">
        <option value="">Sin restricción</option>
        <option value="SNET">No iniciar antes de (SNET)</option>
        <option value="SNLT">No iniciar después de (SNLT)</option>
        <option value="MSO">Debe iniciar el (MSO)</option>
        <option value="MFO">Debe finalizar el (MFO)</option>
        <option value="FNET">No finalizar antes de (FNET)</option>
        <option value="FNLT">No finalizar después de (FNLT)</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Fecha restricción</label><input class="form-input" type="date" id="am-cdate"/></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">Inicio temprano (ES)</label><input class="form-input" id="am-es" readonly style="opacity:.6"/></div>
    <div class="form-group"><label class="form-label">Fin temprano (EF)</label><input class="form-input" id="am-ef" readonly style="opacity:.6"/></div>
    <div class="form-group"><label class="form-label">Holgura Total (TF)</label><input class="form-input" id="am-tf" readonly style="opacity:.6"/></div>
  </div>
  <hr style="border-color:#1f2937;margin:10px 0"/>
  <div style="font-size:10px;font-weight:700;color:#6b7280;margin-bottom:6px;text-transform:uppercase">Línea Base</div>
  <div class="form-row">
    <div class="form-group"><label class="form-label">Dur. Línea Base</label><input class="form-input" id="am-bldur" readonly style="opacity:.6"/></div>
    <div class="form-group"><label class="form-label">Inicio Línea Base</label><input class="form-input" id="am-bles" readonly style="opacity:.6"/></div>
    <div class="form-group"><label class="form-label">Fin Línea Base</label><input class="form-input" id="am-blef" readonly style="opacity:.6"/></div>
  </div>
  <div class="form-group"><label class="form-label">Notas / Supuestos</label><textarea class="form-input" id="am-notes" rows="2"></textarea></div>
  <div style="display:flex;gap:8px;justify-content:space-between;margin-top:14px">
    <button class="btn btn-danger" style="font-size:10px" id="am-del" onclick="deleteFromModal()">&#128465; Eliminar</button>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="closeActModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="saveActModal()">Guardar</button>
    </div>
  </div>
</div>
</div>

<!-- MODAL (proyecto/config) -->
<div id="modal-overlay">
<div id="modal">
  <h2 id="modal-title">Configuración del Proyecto</h2>
  <div class="form-group">
    <label class="form-label">Nombre del Proyecto</label>
    <input class="form-input" id="m-name" value="Mi Proyecto"/>
  </div>
  <div class="form-row">
    <div class="form-group">
      <label class="form-label">Fecha de Inicio</label>
      <input class="form-input" type="date" id="m-start"/>
    </div>
    <div class="form-group">
      <label class="form-label">Status Date (Fecha de Corte)</label>
      <input class="form-input" type="date" id="m-status"/>
    </div>
  </div>
  <div class="form-row">
    <div class="form-group">
      <label class="form-label">Calendario por defecto</label>
      <select class="form-input" id="m-cal">
        <option value="5">5 días/sem (Lun-Vie)</option>
        <option value="6" selected>6 días/sem (Lun-Sáb)</option>
        <option value="7">7 días/sem (continuo)</option>
      </select>
    </div>
  </div>
  <hr style="border-color:#1f2937;margin:12px 0"/>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn btn-danger" style="font-size:10px" onclick="if(confirm('¿Borrar TODAS las actividades?')){activities=[];selIdx=-1;calcCPM();closeModal();}">&#128465; Limpiar todo</button>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
    <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
    <button class="btn btn-primary" onclick="saveProjectModal()">Guardar</button>
  </div>
</div>
</div>

<script>
// 
// ESTADO GLOBAL
// 
let activities = [];
let visRows = [];
let selIdx = -1;        // index in activities[]
let projStart = new Date();
let projName = 'Mi Proyecto';
let defCal = 6;
let zoom = 'week';
let PX = 14;
const ZOOM_PX = {day:30, week:14, month:5};
const ROW_H = 26;
const HDR_H = 36;
let collapsed = new Set();
let totalDays = 400;
let undoStack = [];
let statusDate = new Date(); // Status Date / Fecha de Corte
statusDate.setHours(0,0,0,0);
let lightMode = false;
const TH={
  dark:{
    rowEven:'#0d1422',rowOdd:'#111827',gridMonth:'#1f2937',gridLine:'#141928',
    hdrTopBg:'#1f2937',hdrTopBorder:'#374151',hdrTopText:'#9ca3af',
    hdrBotBg:'#1a2035',hdrBotBorder:'#2d3748',hdrBotText:'#4b5563',hdrWeekend:'#161e2e',
    summaryBar:'#1e293b',barLabel:'rgba(255,255,255,.88)',barLabelOut:'rgba(255,255,255,.88)',
    blBar:'#6b728088',blDiamond:'#6b7280',
    connLine:'rgba(100,116,139,.55)',connCrit:'rgba(239,68,68,.6)',
    todayLine:'#f59e0b55',statusLine:'#06b6d455',
    gradTop:'rgba(255,255,255,.18)',gradBot:'rgba(0,0,0,.1)'
  },
  light:{
    rowEven:'#ffffff',rowOdd:'#f1f5f9',gridMonth:'#94a3b8',gridLine:'#e2e8f0',
    hdrTopBg:'#e2e8f0',hdrTopBorder:'#cbd5e1',hdrTopText:'#334155',
    hdrBotBg:'#f1f5f9',hdrBotBorder:'#cbd5e1',hdrBotText:'#475569',hdrWeekend:'#e8ecf1',
    summaryBar:'#1e293b',barLabel:'#ffffff',barLabelOut:'#1e293b',
    blBar:'#64748bdd',blDiamond:'#475569',
    connLine:'rgba(71,85,105,.5)',connCrit:'rgba(220,38,38,.65)',
    todayLine:'#f59e0b44',statusLine:'#06b6d444',
    gradTop:'rgba(255,255,255,.30)',gradBot:'rgba(0,0,0,.05)'
  }
};
function th(){return lightMode?TH.light:TH.dark;}
function toggleTheme(){
  lightMode=!lightMode;
  document.body.classList.toggle('light',lightMode);
  const btn=document.getElementById('btn-theme');
  if(btn){btn.textContent=lightMode?'\u263E Oscuro':'\u2600 Claro';}
  redraw();
}
function switchRibbonTab(btn){
  document.querySelectorAll('.rtab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.ribbon-panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  const panel=document.getElementById(btn.dataset.panel);
  if(panel) panel.classList.add('active');
}

// ══════════════════════════════════════════════════
// RESOURCE POOL (Hoja de Recursos / Resource Sheet)
// ══════════════════════════════════════════════════
let resourcePool=[]; // global resource pool
let rsSelIdx=-1;     // selected resource row index
let _currentView='gantt'; // 'gantt' | 'resources'
let _rsNextId=1;     // next resource ID counter

function switchMainView(view){
  _currentView=view;
  const ganttZ=document.getElementById('gantt-zone');
  const formZ=document.getElementById('form-zone');
  const formR=document.getElementById('form-resize');
  const rsView=document.getElementById('resource-sheet-view');
  const btnG=document.getElementById('btn-view-gantt');
  const btnR=document.getElementById('btn-view-resources');
  if(view==='resources'){
    ganttZ.style.display='none';
    formZ.style.display='none';
    if(formR) formR.style.display='none';
    rsView.style.display='flex';
    rsView.classList.add('active');
    btnG.classList.remove('act');
    btnR.classList.add('act');
    renderResourceSheet();
  } else {
    ganttZ.style.display='';
    formZ.style.display='';
    if(formR) formR.style.display='';
    rsView.style.display='none';
    rsView.classList.remove('active');
    btnG.classList.add('act');
    btnR.classList.remove('act');
    redraw();
  }
}

function newPoolResource(){
  const id=resourcePool.length?Math.max(...resourcePool.map(r=>r.rid))+1:1;
  return {rid:id, name:'', type:'Trabajo', materialLabel:'', initials:'', group:'', maxCapacity:'100%', stdRate:'0', overtimeRate:'0', costPerUse:'0', accrual:'Prorrateo', calendar:'7d', code:''};
}

function addPoolResource(){
  const r=newPoolResource();
  r.name='Nuevo Recurso';
  r.initials=r.name.split(' ').map(w=>w[0]||'').join('').toUpperCase().substring(0,3);
  resourcePool.push(r);
  rsSelIdx=resourcePool.length-1;
  renderResourceSheet();
  // Focus name cell
  setTimeout(()=>{
    const rows=document.querySelectorAll('#rs-tbody tr:not(.rs-empty)');
    if(rows[rsSelIdx]){
      const nameCell=rows[rsSelIdx].querySelectorAll('td')[2]; // name is 3rd col
      if(nameCell&&nameCell.contentEditable==='true'){nameCell.focus();document.execCommand('selectAll');}
    }
  },50);
}

function deletePoolResource(){
  if(rsSelIdx<0||rsSelIdx>=resourcePool.length) return;
  const r=resourcePool[rsSelIdx];
  if(!confirm('¿Eliminar recurso "'+r.name+'" (ID: R'+r.rid+')?')) return;
  // Remove from pool
  const delRid=r.rid;
  resourcePool.splice(rsSelIdx,1);
  // Remove from activity assignments
  activities.forEach(a=>{
    if(a.resources){
      a.resources=a.resources.filter(ar=>ar.rid!==delRid);
      a.work=a.resources.reduce((s,x)=>s+(x.work||0),0);
      a.res=a.resources.map(x=>{const pr=resourcePool.find(p=>p.rid===x.rid);return pr?pr.name:(x.name||'?');}).join('; ');
    }
  });
  if(rsSelIdx>=resourcePool.length) rsSelIdx=resourcePool.length-1;
  renderResourceSheet();
}

function commitPoolEdit(idx, field, value){
  if(idx<0||idx>=resourcePool.length) return;
  resourcePool[idx][field]=value;
  // Auto-generate initials if name changed and initials is auto
  if(field==='name'){
    resourcePool[idx].initials=value.split(' ').map(w=>w[0]||'').join('').toUpperCase().substring(0,3);
    // Update res string in all activities using this resource
    const rid=resourcePool[idx].rid;
    activities.forEach(a=>{
      if(a.resources){
        const has=a.resources.find(ar=>ar.rid===rid);
        if(has){
          a.res=a.resources.map(x=>{const pr=resourcePool.find(p=>p.rid===x.rid);return pr?pr.name:(x.name||'?');}).join('; ');
        }
      }
    });
  }
}

function _rsSelectRow(idx){
  rsSelIdx=idx;
  document.querySelectorAll('#rs-tbody tr:not(.rs-empty)').forEach((t,ti)=>t.classList.toggle('rs-sel',ti===idx));
}
function renderResourceSheet(){
  const tbody=document.getElementById('rs-tbody');
  tbody.innerHTML='';
  resourcePool.forEach((r,i)=>{
    const tr=document.createElement('tr');
    if(i===rsSelIdx) tr.classList.add('rs-sel');
    // Row click: only update selection visually, never re-render
    tr.addEventListener('mousedown',e=>{
      // Don't steal focus from editable children
      if(e.target.tagName==='SELECT'||e.target.tagName==='INPUT'||e.target.contentEditable==='true') return;
      _rsSelectRow(i);
    });

    // Info cell
    const tdInfo=document.createElement('td');
    tdInfo.innerHTML='&#9432;';
    tdInfo.style.textAlign='center';tdInfo.style.color='#818cf8';tdInfo.style.cursor='pointer';
    tr.appendChild(tdInfo);

    // ID cell
    const tdId=document.createElement('td');
    tdId.textContent='R'+r.rid;
    tdId.style.fontFamily='monospace';tdId.style.color='#818cf8';
    tr.appendChild(tdId);

    // Editable text cells
    const fields=[
      {f:'name',w:180},{f:'type',w:80,select:['Trabajo','Material','Costo']},
      {f:'materialLabel',w:120},{f:'initials',w:65},{f:'group',w:80},
      {f:'maxCapacity',w:90},{f:'stdRate',w:95},{f:'overtimeRate',w:95},
      {f:'costPerUse',w:80},{f:'accrual',w:80,select:['Comienzo','Prorrateo','Fin']},
      {f:'calendar',w:85,select:['5d','6d','7d']},{f:'code',w:70}
    ];
    fields.forEach(col=>{
      const td=document.createElement('td');
      if(col.select){
        const sel=document.createElement('select');
        col.select.forEach(v=>{
          const opt=document.createElement('option');
          opt.value=v;opt.textContent=v;
          if(r[col.f]===v) opt.selected=true;
          sel.appendChild(opt);
        });
        sel.addEventListener('mousedown',()=>{_rsSelectRow(i);});
        sel.addEventListener('change',()=>{commitPoolEdit(i,col.f,sel.value);});
        td.appendChild(sel);
      } else {
        td.contentEditable='true';
        td.textContent=r[col.f]||'';
        td.addEventListener('blur',()=>{commitPoolEdit(i,col.f,td.textContent.trim());});
        td.addEventListener('keydown',e=>{
          if(e.key==='Enter'){e.preventDefault();td.blur();}
          if(e.key==='Tab'){
            e.preventDefault();
            td.blur();
            // Find next editable cell
            let next=td.nextElementSibling;
            while(next){
              if(next.contentEditable==='true'){next.focus();return;}
              const sel=next.querySelector('select');
              if(sel){sel.focus();return;}
              next=next.nextElementSibling;
            }
          }
        });
        td.addEventListener('focus',()=>{_rsSelectRow(i);});
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Empty row for quick add
  const emptyTr=document.createElement('tr');
  emptyTr.className='rs-empty';
  const emptyInfo=document.createElement('td');emptyInfo.textContent='';emptyTr.appendChild(emptyInfo);
  const emptyId=document.createElement('td');emptyId.textContent='';emptyTr.appendChild(emptyId);
  const emptyName=document.createElement('td');
  emptyName.contentEditable='true';emptyName.style.fontStyle='italic';emptyName.setAttribute('placeholder','Escribir nombre...');
  emptyName.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const name=emptyName.textContent.trim();
      if(name){
        const r=newPoolResource();r.name=name;
        r.initials=name.split(' ').map(w=>w[0]||'').join('').toUpperCase().substring(0,3);
        resourcePool.push(r);rsSelIdx=resourcePool.length-1;
        renderResourceSheet();
      }
    }
  });
  emptyTr.appendChild(emptyName);
  for(let x=0;x<11;x++){emptyTr.appendChild(document.createElement('td'));}
  tbody.appendChild(emptyTr);
}

// Helper: get pool resource by rid
function getPoolResource(rid){return resourcePool.find(r=>r.rid===rid);}

// Helper: get pool resource names for autocomplete in activity resource form
function getPoolResourceNames(){return resourcePool.map(r=>({rid:r.rid, name:r.name, initials:r.initials, label:'R'+r.rid+' – '+r.name}));}

// Column definitions: key, label, width, editable, cssClass, visible
const COLS = [
  {key:'_num',   label:'#',             w:30,  edit:false, cls:'tcell-num',  visible:true},
  {key:'_info',  label:'ℹ',             w:24,  edit:false, cls:'tcell-info', visible:true},
  {key:'_mode',  label:'',              w:22,  edit:false, cls:'tcell-num',  visible:true},
  {key:'outlineNum',label:'EDT',        w:55,  edit:false, cls:'tcell-num',  visible:true},
  {key:'id',     label:'ID',            w:65,  edit:true,  cls:'tcell-id',   visible:true},
  {key:'name',   label:'Nombre de tarea',w:220, edit:true,  cls:'tcell-name', visible:true},
  {key:'dur',    label:'Duración',      w:65,  edit:true,  cls:'tcell-dur',  visible:true},
  {key:'remDur', label:'Dur. Restante', w:65,  edit:true,  cls:'tcell-dur',  visible:true},
  {key:'startDate',label:'Comienzo',    w:90,  edit:true,  cls:'tcell-date', visible:true},
  {key:'endDate',label:'Fin',           w:90,  edit:false, cls:'tcell-date', visible:true},
  {key:'predStr',label:'Predecesoras',  w:100, edit:true,  cls:'tcell-pred', visible:true},
  {key:'pct',    label:'% Avance',      w:60,  edit:true,  cls:'tcell-pct',  visible:true},
  {key:'res',    label:'Recursos',      w:110, edit:true,  cls:'tcell-res',  visible:true},
  {key:'work',   label:'Trabajo',       w:70,  edit:true,  cls:'tcell-dur',  visible:true},
  {key:'weight', label:'Peso %',        w:65,  edit:true,  cls:'tcell-pct',  visible:true},
  {key:'cal',    label:'Calendario',    w:60,  edit:'select', cls:'tcell-cal',  visible:true},
  {key:'TF',     label:'Holgura Total', w:75,  edit:false, cls:'tcell-dur',  visible:true},
  {key:'blDur',  label:'Dur. LB',       w:60,  edit:false, cls:'tcell-dur',  visible:false},
  {key:'blStart',label:'Inicio LB',     w:90,  edit:false, cls:'tcell-date', visible:false},
  {key:'blEnd',  label:'Fin LB',        w:90,  edit:false, cls:'tcell-date', visible:false},
  {key:'type',   label:'Tipo',          w:70,  edit:false, cls:'tcell-num',  visible:false},
  {key:'lv',     label:'WBS/Nivel',     w:50,  edit:false, cls:'tcell-num',  visible:false},
  {key:'constraint',label:'Restricción',w:80,  edit:false, cls:'tcell-date', visible:false},
  {key:'constraintDate',label:'Fecha Restr.',w:90,edit:false,cls:'tcell-date',visible:false},
  {key:'notes',  label:'Notas',         w:120, edit:true,  cls:'tcell-name', visible:false},
  {key:'txt1',   label:'Texto 1',       w:100, edit:true,  cls:'tcell-name', visible:false},
  {key:'txt2',   label:'Texto 2',       w:100, edit:true,  cls:'tcell-name', visible:false},
  {key:'txt3',   label:'Texto 3',       w:100, edit:true,  cls:'tcell-name', visible:false},
  {key:'txt4',   label:'Texto 4',       w:100, edit:true,  cls:'tcell-name', visible:false},
  {key:'txt5',   label:'Texto 5',       w:100, edit:true,  cls:'tcell-name', visible:false},
];
let colOrder = COLS.map((_,i)=>i); // track column display order
function visCols(){return colOrder.map(i=>COLS[i]).filter(c=>c.visible);}
let colWidths = COLS.map(c=>c.w);
const totalColW = ()=> COLS.reduce((s,c,i)=>s+(c.visible?colWidths[i]:0),0);
let showProjRow = true; // EDT Nivel 0 project summary row

// Calendar factors
const CAL_F = {5:7/5, 6:7/6, 7:1};

// 
// UTILS
// 
function addWorkDays(d,wd,cal){const f=CAL_F[cal]||CAL_F[6];const c=Math.round(wd*f);const r=new Date(d);r.setDate(r.getDate()+c);return r;}
function addDays(d,n){const r=new Date(d);r.setDate(r.getDate()+n);return r;}
function dayDiff(a,b){return Math.round((b-a)/864e5);}
function calWorkDays(a,b,cal){const cd=dayDiff(a,b);const f=CAL_F[cal]||CAL_F[6];return Math.max(0,Math.round(cd/f));}
function fmt(d){if(!d)return'';const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yy=String(d.getFullYear()).slice(-2);return dd+'-'+mm+'-'+yy;}
function fmtShort(d){if(!d)return'';const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yy=String(d.getFullYear()).slice(-2);return dd+'-'+mm+'-'+yy;}
function isoDate(d){if(!d)return'';return d.toISOString().slice(0,10);}
function parseDate(s){if(!s)return null;
  // Accept dd-mm-yy format
  let m=String(s).match(/^(\d{1,2})-(\d{1,2})-(\d{2})$/);
  if(m){const yr=parseInt(m[3])+(parseInt(m[3])>50?1900:2000);const d=new Date(yr,parseInt(m[2])-1,parseInt(m[1]));return isNaN(d)?null:d;}
  // Accept yyyy-mm-dd (ISO) or any standard format
  const d=new Date(s+'T00:00:00');return isNaN(d)?null:d;
}

function newActivity(id){
  return {id:id||'',name:'',type:'task',dur:5,remDur:null,cal:defCal,pct:0,preds:[],notes:'',res:'',work:0,weight:null,resources:[],
    lv:0,constraint:'MSO',constraintDate:isoDate(new Date()),manual:true,
    ES:null,EF:null,LS:null,LF:null,TF:null,crit:false,
    blDur:null,blES:null,blEF:null,txt1:'',txt2:'',txt3:'',txt4:'',txt5:''};
}

function pushUndo(){
  undoStack.push(JSON.stringify(activities));
  if(undoStack.length>40) undoStack.shift();
}
function undoAction(){
  if(!undoStack.length) return;
  activities = JSON.parse(undoStack.pop());
  calcCPM();
}

// 
// CUT / PASTE / MOVE
// 
let clipboard=null; // {items:[], fromIdx}
function cutActivity(){
  if(selIdx<0)return;
  if(activities[selIdx]._isProjRow)return;
  pushUndo();
  // Collect the selected activity + its children (if summary)
  const a=activities[selIdx];
  const items=[a];
  if(a.type==='summary'){
    for(let j=selIdx+1;j<activities.length;j++){
      if(activities[j].lv<=a.lv) break;
      items.push(activities[j]);
    }
  }
  clipboard={items:JSON.parse(JSON.stringify(items)),baseLv:a.lv};
  // Remove from activities array
  activities.splice(selIdx,items.length);
  if(selIdx>=activities.length) selIdx=Math.max(0,activities.length-1);
  document.getElementById('btn-paste').disabled=false;
  document.getElementById('btn-paste').style.color='#22c55e';
  calcCPM();
}
function pasteActivity(){
  if(!clipboard||!clipboard.items.length)return;
  pushUndo();
  const insertAt=selIdx>=0?selIdx+1:activities.length;
  // Determine the target level: if pasting after a summary, nest inside it
  let targetLv=0;
  if(selIdx>=0){
    const target=activities[selIdx];
    if(target.type==='summary') targetLv=target.lv+1;
    else targetLv=target.lv;
  }
  const lvDelta=targetLv-clipboard.baseLv;
  const pasted=clipboard.items.map(a=>{
    const na={...newActivity(),...a};
    na.lv=Math.max(0,a.lv+lvDelta);
    return na;
  });
  activities.splice(insertAt,0,...pasted);
  selIdx=insertAt;
  clipboard=null;
  document.getElementById('btn-paste').disabled=true;
  document.getElementById('btn-paste').style.color='';
  calcCPM();
}
function moveRow(dir){
  if(selIdx<0)return;
  if(activities[selIdx]._isProjRow)return;
  const a=activities[selIdx];
  // Collect activity + children
  let count=1;
  if(a.type==='summary'){
    for(let j=selIdx+1;j<activities.length;j++){
      if(activities[j].lv<=a.lv) break;
      count++;
    }
  }
  const newIdx=selIdx+dir;
  if(dir<0 && newIdx<0) return;
  if(dir>0 && selIdx+count>=activities.length) return;
  pushUndo();
  const chunk=activities.splice(selIdx,count);
  const insertAt=dir<0?newIdx:newIdx+count-1;
  activities.splice(insertAt,0,...chunk);
  selIdx=insertAt;
  calcCPM();
}

// 
// CPM
// 
function calcCPM(){
  ensureProjRow();
  if(activities.length && activities[0]._isProjRow) activities[0].name=projName||'Mi Proyecto';
  if(!activities.length){ visRows=[]; redraw(); updateFormPanel(); return; }
  const byId={};
  activities.forEach(a=>{
    byId[a.id]=a;
    a.ES=null;a.EF=null;a.LS=null;a.LF=null;a.TF=null;a.crit=false;
    a._remStart=null;a._remDur=null;a._doneDur=null;a._origDur=null;a._actualEnd=null;
  });

  // ═══ FORWARD PASS (Pasada hacia adelante) ═══
  function getES(a){
    if(a.ES!==null) return a.ES;
    let es=new Date(projStart);
    let forced=false;
    // Manual start / MSO constraint = fixed date, ignores predecessors
    if((a.manual || a.constraint==='MSO') && a.constraintDate){
      const cd=parseDate(a.constraintDate);
      if(cd){es=new Date(cd);forced=true;}
    } else if(a.constraint==='SNET'){
      const cd=parseDate(a.constraintDate);
      if(cd) es=new Date(Math.max(es,cd));
    }
    if(!forced && a.preds&&a.preds.length){
      a.preds.forEach(p=>{
        const pred=byId[p.id]; if(!pred) return;
        if(pred.type==='summary'||a.type==='summary') return; // skip summary links
        getES(pred); // ensure pred is calculated
        const pEF=pred.EF||addWorkDays(pred.ES||projStart,pred.type==='milestone'?0:(pred.dur||0),pred.cal||defCal);
        const pES=pred.ES||projStart;
        let t; const lag=p.lag||0;
        if(p.type==='FS') t=addWorkDays(pEF,lag,a.cal||defCal);
        else if(p.type==='SS') t=addWorkDays(pES,lag,a.cal||defCal);
        else if(p.type==='FF'){t=addDays(addWorkDays(pEF,lag,a.cal||defCal),-Math.round((a.type==='milestone'?0:(a.dur||0))*(CAL_F[a.cal||defCal]||1)));}
        else if(p.type==='SF'){t=addDays(addWorkDays(pES,lag,a.cal||defCal),-Math.round((a.type==='milestone'?0:(a.dur||0))*(CAL_F[a.cal||defCal]||1)));}
        else t=addWorkDays(pEF,lag,a.cal||defCal);
        if(t>es) es=new Date(t);
      });
    }
    a.ES=es;
    a.EF=addWorkDays(es,a.type==='milestone'?0:(a.dur||0),a.cal||defCal);
    return a.ES;
  }
  activities.forEach(a=>getES(a));

  // ═══ RETAINED LOGIC (Lógica Retenida) ═══
  // Aplica Status Date: reprograma partes incompletas post Status Date
  // respetando la lógica de relaciones
  if(statusDate){
    const sd=new Date(statusDate);

    // Paso 1: Calcular fechas retenidas para cada actividad individual
    activities.forEach(a=>{
      if(a.type==='summary'||a.type==='milestone') return;
      const pct=a.pct||0;
      if(pct>=100) return; // completada, no mover

      if(pct>0 && pct<100){
        const origDur=a.dur||0;
        const doneDur=Math.round(origDur*pct/100);
        const remDur=a.remDur!=null?a.remDur:(origDur-doneDur);
        const origES=new Date(a.ES);
        a._actualEnd=addWorkDays(origES,doneDur,a.cal||defCal);
        a._doneDur=doneDur;
        a._remDur=remDur;
        a._origDur=origDur;
        // El remaining start mínimo es statusDate
        a._remStart=new Date(sd);
      } else if(pct===0){
        a._origDur=a.dur||0;
      }
    });

    // Paso 2: Recalcular forward pass respetando relaciones (Lógica Retenida)
    // Para cada actividad, su nuevo ES debe considerar:
    // - statusDate (si no está completada)
    // - EF de sus predecesoras (respetando relaciones)
    activities.forEach(a=>{
      a._retES=null; a._retEF=null;
    });

    function getRetES(a){
      if(a._retES!==null) return a._retES;
      const pct=a.pct||0;
      if(a.type==='summary'||pct>=100){
        a._retES=a.ES; a._retEF=a.EF;
        return a._retES;
      }

      let newES=new Date(a.type==='milestone'?a.ES:sd); // milestones: keep original ES as base
      if(pct>0){
        // Parcial: el remaining empieza desde statusDate como mínimo
        newES=new Date(sd);
      }

      // Respetar relaciones con predecesoras
      if(a.preds&&a.preds.length){
        a.preds.forEach(p=>{
          const pred=byId[p.id]; if(!pred) return;
          if(pred.type==='summary') return; // skip summary links
          getRetES(pred);
          const pEF=pred._retEF||pred.EF;
          const pES=pred._retES||pred.ES;
          let t; const lag=p.lag||0;
          if(p.type==='FS') t=addWorkDays(pEF,lag,a.cal||defCal);
          else if(p.type==='SS') t=addWorkDays(pES,lag,a.cal||defCal);
          else if(p.type==='FF'){t=addDays(addWorkDays(pEF,lag,a.cal||defCal),-Math.round((a.type==='milestone'?0:(a._remDur||a.dur||0))*(CAL_F[a.cal||defCal]||1)));}
          else if(p.type==='SF'){t=addDays(addWorkDays(pES,lag,a.cal||defCal),-Math.round((a.type==='milestone'?0:(a._remDur||a.dur||0))*(CAL_F[a.cal||defCal]||1)));}
          else t=addWorkDays(pEF,lag,a.cal||defCal);
          if(t>newES) newES=new Date(t);
        });
      }

      if(pct>0 && pct<100 && a.type!=='milestone'){
        // Parcial: remaining start
        a._remStart=newES;
        const newEF=addWorkDays(newES,a._remDur,a.cal||defCal);
        a._retES=a.ES; // ES original se mantiene (parte completada)
        a._retEF=newEF;
        a.EF=newEF;
      } else {
        // 0% o milestone: reprogramar completa desde newES
        if(newES>a.ES){
          a.ES=newES;
          const effDur=a.type==='milestone'?0:(a.remDur!=null?a.remDur:(a.dur||0));
          a.EF=addWorkDays(newES,effDur,a.cal||defCal);
        }
        a._retES=a.ES;
        a._retEF=a.EF;
      }
      return a._retES;
    }
    activities.forEach(a=>getRetES(a));

    // Recalcular duración como días hábiles entre ES y EF
    activities.forEach(a=>{
      if(a.type==='summary'||a.type==='milestone') return;
      if(a.ES && a.EF){
        a.dur=calWorkDays(a.ES,a.EF,a.cal||defCal);
      }
    });
  }

  // Summary tasks: compute ES/EF from children range (top-down is fine for dates)
  for(let i=0;i<activities.length;i++){
    const a=activities[i];
    if(a.type!=='summary') continue;
    let minES=null, maxEF=null;
    if(a._isProjRow){
      for(let j=1;j<activities.length;j++){
        const ch=activities[j];
        if(ch.ES&&(!minES||ch.ES<minES)) minES=new Date(ch.ES);
        if(ch.EF&&(!maxEF||ch.EF>maxEF)) maxEF=new Date(ch.EF);
      }
    } else {
      for(let j=i+1;j<activities.length;j++){
        if(activities[j].lv<=a.lv) break;
        const ch=activities[j];
        if(ch.ES&&(!minES||ch.ES<minES)) minES=new Date(ch.ES);
        if(ch.EF&&(!maxEF||ch.EF>maxEF)) maxEF=new Date(ch.EF);
      }
    }
    if(minES) a.ES=minES;
    if(maxEF) a.EF=maxEF;
    if(minES&&maxEF){
      const calDays=dayDiff(minES,maxEF);
      const factor=CAL_F[a.cal||defCal]||1;
      a.dur=Math.max(1,Math.round(calDays/factor));
    }
  }

  // Summary tasks: compute work + weighted pct BOTTOM-UP (so nested summaries compute first)
  for(let i=activities.length-1;i>=0;i--){
    const a=activities[i];
    if(a.type!=='summary') continue;
    let sumWork=0, sumWeightedPct=0, sumWeight=0;
    if(a._isProjRow){
      for(let j=1;j<activities.length;j++){
        if(activities[j].lv!==0) continue;
        const ch=activities[j];
        const cw=ch.work||0;
        sumWork+=cw;
        const w=(ch.weight!=null&&ch.weight>0)?ch.weight:cw;
        sumWeight+=w;
        sumWeightedPct+=w*(ch.pct||0);
      }
    } else {
      for(let j=i+1;j<activities.length;j++){
        if(activities[j].lv<=a.lv) break;
        if(activities[j].lv!==a.lv+1) continue;
        const ch=activities[j];
        const cw=ch.work||0;
        sumWork+=cw;
        const w=(ch.weight!=null&&ch.weight>0)?ch.weight:cw;
        sumWeight+=w;
        sumWeightedPct+=w*(ch.pct||0);
      }
    }
    a.work=Math.round(sumWork*100)/100;
    a.pct=sumWeight>0?Math.round(sumWeightedPct/sumWeight*10)/10:0;
  }

  let projEnd=new Date(projStart);
  activities.forEach(a=>{if(a.EF&&a.EF>projEnd) projEnd=new Date(a.EF);});
  totalDays=Math.max(90,dayDiff(projStart,projEnd)+60);

  activities.forEach(a=>{a.LF=new Date(projEnd);});
  const sorted=[...activities].sort((a,b)=>(b.EF||projEnd)-(a.EF||projEnd));
  sorted.forEach(a=>{
    a.LS=addDays(a.LF,-Math.round((a.type==='milestone'?0:(a.dur||0))*(CAL_F[a.cal||defCal]||1)));
    if(a.preds) a.preds.forEach(p=>{
      const pred=byId[p.id]; if(!pred) return;
      let newLF;const lag=p.lag||0;
      if(p.type==='FS') newLF=addWorkDays(a.LS,-lag,pred.cal||defCal);
      else if(p.type==='SS') newLF=addDays(addWorkDays(a.LS,-lag,pred.cal||defCal),Math.round((pred.type==='milestone'?0:(pred.dur||0))*(CAL_F[pred.cal||defCal]||1)));
      else if(p.type==='FF') newLF=addWorkDays(a.LF,-lag,pred.cal||defCal);
      else newLF=addWorkDays(a.LS,-lag,pred.cal||defCal);
      if(!pred.LF||newLF<pred.LF) pred.LF=new Date(newLF);
    });
  });
  activities.forEach(a=>{
    if(!a.LF) a.LF=new Date(projEnd);
    a.LS=addDays(a.LF,-Math.round((a.type==='milestone'?0:(a.dur||0))*(CAL_F[a.cal||defCal]||1)));
    const tf=dayDiff(a.ES||projStart,a.LS||projStart);
    a.TF=Math.max(0,tf);
    a.crit=a.TF<=1; // critical regardless of pct
    // Compute remaining duration: if user hasn't set it manually, default = dur*(100-pct)/100
    if(a.remDur===null||a.remDur===undefined){
      a.remDur=Math.round((a.dur||0)*(100-(a.pct||0))/100);
    }
  });
  // Compute outline numbers
  computeOutlineNumbers();
  buildVisRows();
  redraw();
  updateFormPanel();
  // Auto-save to Supabase (debounced)
  if(typeof sbAutoSave==='function') sbAutoSave();
}

// 
// VISIBLE ROWS
// 
function buildVisRows(){
  visRows=[];
  let skipLv=-999;
  activities.forEach((a,i)=>{
    if(skipLv>-999){
      if(a.lv>skipLv){return;}
      else skipLv=-999;
    }
    if(collapsed.has(a.id)&&a.type==='summary'){
      visRows.push({...a,_idx:i});
      skipLv=a.lv;
      return;
    }
    visRows.push({...a,_idx:i});
  });
  // Apply grouping filter
  if(activeGroup&&activeGroup!=='none'){
    visRows=applyGroupFilter(visRows);
  }
}
function collapseAll(){activities.forEach(a=>{if(a.type==='summary') collapsed.add(a.id);});buildVisRows();redraw();}
function expandAll(){collapsed.clear();buildVisRows();redraw();}
function toggleC(id){collapsed.has(id)?collapsed.delete(id):collapsed.add(id);buildVisRows();redraw();}
function collapseToOutline(maxLv){
  collapsed.clear();
  if(maxLv<0){buildVisRows();redraw();return;}
  activities.forEach(a=>{
    if(a.type==='summary' && a.lv>=maxLv) collapsed.add(a.id);
  });
  buildVisRows();redraw();
}

// GROUPING / FILTERING
let activeGroup='none';
function setGrouping(g){
  activeGroup=g;
  buildVisRows();redraw();
}
function applyGroupFilter(rows){
  if(activeGroup==='none') return rows;
  // Simple filters
  if(activeGroup==='critical') return rows.filter(vr=>{const a=activities[vr._idx];return a._isProjRow||a.type==='summary'||a.crit;});
  if(activeGroup==='inprogress') return rows.filter(vr=>{const a=activities[vr._idx];return a._isProjRow||a.type==='summary'||((a.pct||0)>0&&(a.pct||0)<100&&a.type==='task');});
  if(activeGroup==='notstarted') return rows.filter(vr=>{const a=activities[vr._idx];return a._isProjRow||a.type==='summary'||((a.pct||0)===0&&a.type==='task');});
  if(activeGroup==='completed') return rows.filter(vr=>{const a=activities[vr._idx];return a._isProjRow||a.type==='summary'||(a.pct||0)>=100;});
  // Group by text field: sort by value and insert group header rows
  if(activeGroup.startsWith('txt')){
    const field=activeGroup;
    // Collect tasks (non-summary, non-project) and separate summaries/project
    const special=[], tasks=[];
    rows.forEach(vr=>{
      const a=activities[vr._idx];
      if(a._isProjRow) special.push(vr);
      else tasks.push(vr);
    });
    // Build groups by value
    const groups=new Map(); // value -> [rows]
    tasks.forEach(vr=>{
      const a=activities[vr._idx];
      const val=String(a[field]||'').trim()||'(Sin valor)';
      if(!groups.has(val)) groups.set(val,[]);
      groups.get(val).push(vr);
    });
    // Build result: project row first, then each group with header
    const result=[...special];
    const colLabel=COLS.find(c=>c.key===field);
    const fieldLabel=colLabel?colLabel.label:field;
    for(const [val,grpRows] of groups){
      result.push({_isGroupHeader:true, _groupLabel:fieldLabel+': '+val, _groupCount:grpRows.length, id:'__grp_'+val});
      grpRows.forEach(vr=>result.push(vr));
    }
    return result;
  }
  return rows;
}
function updateGroupDropdownLabels(){
  const sel=document.getElementById('tb-group');
  if(!sel) return;
  const opts=sel.querySelectorAll('option');
  opts.forEach(o=>{
    if(o.value.startsWith('txt')){
      const col=COLS.find(c=>c.key===o.value);
      if(col) o.textContent=col.label;
    }
  });
}

// Custom column label helpers (for renaming Texto 1-5)
function getCustomLabels(){
  const labels={};
  COLS.forEach(c=>{if(c.key.startsWith('txt')) labels[c.key]=c.label;});
  return labels;
}
function restoreCustomLabels(labels){
  if(!labels) return;
  COLS.forEach(c=>{if(labels[c.key]) c.label=labels[c.key];});
}

// CONNECTION LINE HIT TEST (for clicking on links)
let _connLines=[]; // stored after drawBars for click detection
function hitTestConnection(mx,my){
  const scrollTop=document.getElementById('gr-body').scrollTop;
  const absY=my+scrollTop;
  for(let i=_connLines.length-1;i>=0;i--){
    const cl=_connLines[i];
    // Check proximity to each segment
    for(let s=0;s<cl.segments.length;s++){
      const seg=cl.segments[s];
      const dist=distToSegment(mx,absY,seg.x1,seg.y1,seg.x2,seg.y2);
      if(dist<6) return {sucId:cl.sucId,predId:cl.predId,predIdx:cl.predIdx,type:cl.type,lag:cl.lag};
    }
  }
  return null;
}
function distToSegment(px,py,x1,y1,x2,y2){
  const dx=x2-x1,dy=y2-y1;
  const len2=dx*dx+dy*dy;
  if(len2===0) return Math.sqrt((px-x1)*(px-x1)+(py-y1)*(py-y1));
  let t=((px-x1)*dx+(py-y1)*dy)/len2;
  t=Math.max(0,Math.min(1,t));
  const cx=x1+t*dx,cy=y1+t*dy;
  return Math.sqrt((px-cx)*(px-cx)+(py-cy)*(py-cy));
}

// Outline Numbers (EDT) like MS Project
function computeOutlineNumbers(){
  const counters=[];
  activities.forEach(a=>{
    if(a._isProjRow) { a._outlineNum='0'; return; }
    const lv=a.lv||0;
    while(counters.length<=lv) counters.push(0);
    for(let i=lv+1;i<counters.length;i++) counters[i]=0;
    counters[lv]++;
    a._outlineNum=counters.slice(0,lv+1).join('.');
  });
}

// Ensure EDT Level 0 project summary row exists
function ensureProjRow(){
  if(!showProjRow) {
    activities = activities.filter(a=>!a._isProjRow);
    return;
  }
  if(activities.length && activities[0]._isProjRow) return;
  const pr = newActivity('PROY');
  pr.name = projName || 'Mi Proyecto';
  pr.type = 'summary';
  pr.lv = -1;
  pr._isProjRow = true;
  activities.unshift(pr);
  if(selIdx>=0) selIdx++;
}
function toggleProjRow(){
  showProjRow=!showProjRow;
  const btn=document.getElementById('btn-edt0');
  if(btn) btn.classList.toggle('act',showProjRow);
  calcCPM();
}

// Compute weight as percentage relative to siblings
function getWeightPct(a){
  if(a._isProjRow) return '100%';
  const idx=activities.indexOf(a);
  if(idx<0) return '0%';
  let parentIdx=-1;
  for(let j=idx-1;j>=0;j--){
    if(activities[j].lv<a.lv){ parentIdx=j; break; }
  }
  let totalW=0;
  const start=parentIdx>=0?parentIdx+1:0;
  for(let j=start;j<activities.length;j++){
    if(j!==start && parentIdx>=0 && activities[j].lv<=activities[parentIdx].lv) break;
    if(activities[j].lv!==a.lv) continue;
    if(activities[j]._isProjRow) continue;
    const ch=activities[j];
    totalW+=(ch.weight!=null&&ch.weight>0)?ch.weight:(ch.work||0);
  }
  const myW=(a.weight!=null&&a.weight>0)?a.weight:(a.work||0);
  if(totalW<=0) return '0%';
  return (Math.round(myW/totalW*1000)/10)+'%';
}

// Baseline
function saveBaseline(){
  if(!activities.length){alert('No hay actividades');return;}
  pushUndo();
  activities.forEach(a=>{
    a.blDur=a.dur;
    a.blES=a.ES?new Date(a.ES):null;
    a.blEF=a.EF?new Date(a.EF):null;
  });
  redraw();
  alert('Línea Base guardada para '+activities.length+' actividades');
}

// 
// PARSE/FORMAT PREDECESSORS STRING
// 
function predsToStr(preds){
  if(!preds||!preds.length) return '';
  return preds.map(p=>{
    const lag=p.lag>0?'+'+p.lag:p.lag<0?''+p.lag:'';
    return p.id+(p.type!=='FS'?' '+p.type:'')+lag;
  }).join('; ');
}
function strToPreds(s){
  if(!s||!s.trim()) return [];
  return s.split(/[;,]/).map(t=>{
    t=t.trim(); if(!t) return null;
    const m=t.match(/^(\S+?)(?:\s+(FS|SS|FF|SF))?([+-]\d+)?$/i);
    if(!m) return null;
    return {id:m[1], type:(m[2]||'FS').toUpperCase(), lag:parseInt(m[3]||'0')};
  }).filter(Boolean);
}

// 
// BUILD TABLE (LEFT PANEL)
// 
function buildHeader(){
  const hdr=document.getElementById('gl-header');
  hdr.innerHTML='';
  hdr.style.width=totalColW()+'px';
  const vc=visCols();
  vc.forEach((c,vcIdx)=>{
    const ci=COLS.indexOf(c);
    const d=document.createElement('div');
    d.className='col-hdr';
    d.style.width=colWidths[ci]+'px';
    d.style.position='relative';
    d.textContent=c.label;
    // Resize handle
    const rh=document.createElement('div');
    rh.className='col-rsz';
    rh.addEventListener('mousedown',e=>{e.stopPropagation();startColResize(e,ci);});
    d.appendChild(rh);
    // Right-click context menu for column visibility
    d.addEventListener('contextmenu',e=>{e.preventDefault();showColContextMenu(e);});
    // Double-click to rename Texto columns
    if(c.key.startsWith('txt')){
      d.style.cursor='pointer';
      d.addEventListener('dblclick',e=>{
        e.stopPropagation();
        const newName=prompt('Renombrar columna "'+c.label+'":', c.label);
        if(newName && newName.trim()){
          COLS[ci].label=newName.trim();
          updateGroupDropdownLabels();
          redraw();
        }
      });
    }

    // Drag & drop reorder (skip fixed columns)
    const fixedKeys=['_num','_info','_mode'];
    if(!fixedKeys.includes(c.key)){
      d.draggable=true;
      d.addEventListener('dragstart',e=>{
        e.dataTransfer.effectAllowed='move';
        _dragColIdx=colOrder.indexOf(ci);
        d.classList.add('col-dragging');
      });
      d.addEventListener('dragend',()=>{
        d.classList.remove('col-dragging');
        hdr.querySelectorAll('.col-hdr').forEach(h=>{h.classList.remove('col-drag-over','col-drag-over-right');});
        _dragColIdx=-1;
      });
      d.addEventListener('dragover',e=>{
        e.preventDefault();
        e.dataTransfer.dropEffect='move';
        const targetOIdx=colOrder.indexOf(ci);
        hdr.querySelectorAll('.col-hdr').forEach(h=>{h.classList.remove('col-drag-over','col-drag-over-right');});
        if(_dragColIdx>=0 && targetOIdx!==_dragColIdx){
          d.classList.add(targetOIdx<_dragColIdx?'col-drag-over':'col-drag-over-right');
        }
      });
      d.addEventListener('dragleave',()=>{
        d.classList.remove('col-drag-over','col-drag-over-right');
      });
      d.addEventListener('drop',e=>{
        e.preventDefault();
        const targetOIdx=colOrder.indexOf(ci);
        if(_dragColIdx>=0 && targetOIdx!==_dragColIdx){
          const moved=colOrder.splice(_dragColIdx,1)[0];
          colOrder.splice(targetOIdx,0,moved);
          redraw();
        }
      });
    }

    hdr.appendChild(d);
  });
}
let _dragColIdx=-1;

function buildRows(){
  const body=document.getElementById('gl-body');
  body.innerHTML='';
  const wrap=document.createElement('div');
  wrap.style.width=totalColW()+'px';
  const VC=visCols();

  // Existing activities
  visRows.forEach((vr,vi)=>{
    // Group header row
    if(vr._isGroupHeader){
      const row=document.createElement('div');
      row.className='trow trow-group';
      row.style.width=totalColW()+'px';
      const cell=document.createElement('div');
      cell.className='tcell';
      cell.style.width=totalColW()+'px';
      cell.style.paddingLeft='8px';
      cell.innerHTML='&#9660; <b>'+vr._groupLabel+'</b> <span style="font-weight:400;opacity:.7;font-size:10px">('+vr._groupCount+' actividades)</span>';
      row.appendChild(cell);
      wrap.appendChild(row);
      return;
    }
    const a=activities[vr._idx];
    const row=document.createElement('div');
    const lvC=a._isProjRow?'trow-proj':'trow-lv'+Math.min(a.lv,2);
    const typeC=a._isProjRow?'':(a.type==='summary'?' trow-summary':' trow-task');
    row.className='trow '+lvC+typeC+(selIdx===vr._idx?' sel':'');
    row.style.width=totalColW()+'px';
    row.dataset.idx=vr._idx;

    VC.forEach((c,vci)=>{
      const ci=COLS.indexOf(c);
      const cell=document.createElement('div');
      cell.className='tcell '+c.cls;
      cell.style.width=colWidths[ci]+'px';

      let val='';
      if(c.key==='_num') val=vi+1;
      else if(c.key==='_mode'){
        const isSummary=a.type==='summary';
        const colld=collapsed.has(a.id);
        if(isSummary) val=colld?'&#9654;':'&#9660;';
        else val='';
      }
      else if(c.key==='outlineNum') val=a._outlineNum||'';
      else if(c.key==='dur') val=a.type==='milestone'?'0 días':(a.dur||0)+' días';
      else if(c.key==='remDur') val=a.type==='milestone'?'0 días':(a.remDur!=null?a.remDur:(a.dur||0))+' días';
      else if(c.key==='startDate') val=a.ES?fmtShort(a.ES):'';
      else if(c.key==='endDate') val=a.EF?fmtShort(addDays(a.EF,-1)):'';
      else if(c.key==='predStr') val=predsToStr(a.preds);
      else if(c.key==='name'){
        const pad=2+Math.max(0,a.lv)*14;
        cell.style.paddingLeft=pad+'px';
        val=a.name||'';
      }
      else if(c.key==='pct') val=(a.pct||0)+'%';
      else if(c.key==='type') val=a.type==='milestone'?'Hito':a.type==='summary'?'Resumen':'Tarea';
      else if(c.key==='lv') val=a.lv;
      else if(c.key==='cal') val=(a.cal||defCal)+'d';
      else if(c.key==='blDur') val=a.blDur!=null?a.blDur+' días':'';
      else if(c.key==='blStart') val=a.blES?fmtShort(a.blES):'';
      else if(c.key==='blEnd') val=a.blEF?fmtShort(addDays(a.blEF,-1)):'';
      else if(c.key==='constraint') val=a.constraint||'';
      else if(c.key==='constraintDate') val=a.constraintDate||'';
      else if(c.key==='notes') val=(a.notes||'').substring(0,40);
      else if(c.key==='work') val=a.type==='milestone'?'0 hrs':((a.work||0)+' hrs');
      else if(c.key==='TF'){
        if(a.type==='summary'||a._isProjRow) val='';
        else if(a.TF!=null) val=a.TF+'d';
        else val='';
        if(a.TF===0) cell.style.color='#ef4444';
        else if(a.TF!=null&&a.TF<=3) cell.style.color='#f59e0b';
        else if(a.TF!=null) cell.style.color='#22c55e';
      }
      else if(c.key==='weight'){
        val=getWeightPct(a);
        if(a.weight!=null&&a.weight>0) cell.style.color='#fbbf24';
      }
      else val=a[c.key]!=null?a[c.key]:'';

      // Set default text content first
      cell.innerHTML=val;

      // Calendar column: render as select dropdown (replaces innerHTML)
      if(c.key==='cal' && c.edit==='select'){
        cell.contentEditable='false';
        cell.innerHTML=''; // clear text
        const sel=document.createElement('select');
        sel.className='fp-cell-edit';
        sel.style.cssText='width:100%;height:100%;background:transparent;border:none;color:inherit;font-size:11px;outline:none;cursor:pointer;';
        [{v:5,l:'5d'},{v:6,l:'6d'},{v:7,l:'7d'}].forEach(o=>{
          const opt=document.createElement('option');
          opt.value=o.v;opt.textContent=o.l;opt.style.background=lightMode?'#fff':'#1f2937';opt.style.color=lightMode?'#1e293b':'#e5e7eb';
          if((a.cal||defCal)===o.v) opt.selected=true;
          sel.appendChild(opt);
        });
        sel.addEventListener('change',()=>{
          pushUndo();
          activities[vr._idx].cal=parseInt(sel.value);
          calcCPM();
        });
        sel.addEventListener('focus',()=>{selectRowByIdx(vr._idx);});
        cell.appendChild(sel);
      } else if(c.edit===true){
        // Block editing computed fields on summaries, and ALL fields on project row
        const summaryReadOnly = a._isProjRow || (a.type==='summary' && (c.key==='work'||c.key==='pct'||c.key==='dur'));
        if(summaryReadOnly){
          cell.contentEditable='false';
          cell.style.opacity='0.7';
        } else {
        cell.contentEditable='true';
        cell.spellcheck=false;
        cell.addEventListener('focus',()=>{selectRowByIdx(vr._idx);});
        cell.addEventListener('blur',()=>{commitEdit(vr._idx, c.key, cell.textContent.trim());});
        cell.addEventListener('keydown',e=>{
          if(e.key==='Enter'){e.preventDefault();cell.blur();
            const nextRow=row.nextElementSibling;
            if(nextRow){const nc=nextRow.children[vci];if(nc&&nc.contentEditable==='true') nc.focus();}
          }
          if(e.key==='Tab'){
            e.preventDefault();
            let ni=vci+1;
            while(ni<VC.length&&VC[ni].edit!==true) ni++;
            if(ni<VC.length){row.children[ni].focus();}
            else{
              const nextRow=row.nextElementSibling;
              if(nextRow){
                let fi=0; while(fi<VC.length&&VC[fi].edit!==true) fi++;
                if(fi<VC.length) nextRow.children[fi].focus();
              }
            }
          }
          if(e.key==='Escape'){cell.textContent=val;cell.blur();}
        });
        } // end else (not summaryReadOnly)
      }

      // Info column click = open activity detail modal
      if(c.key==='_info' && a.id){
        cell.innerHTML='&#9432;';
        cell.style.cursor='pointer';
        cell.addEventListener('click',e=>{e.stopPropagation();selectRowByIdx(vr._idx);showActModal();});
      }

      // Mode column click = collapse/expand
      if(c.key==='_mode' && a.type==='summary'){
        cell.style.cursor='pointer';
        cell.addEventListener('click',e=>{e.stopPropagation();toggleC(a.id);});
      }

      row.appendChild(cell);
    });

    row.addEventListener('click',()=>{selectRowByIdx(vr._idx);});
    row.addEventListener('dblclick',()=>{selectRowByIdx(vr._idx);showActModal();});
    row.addEventListener('mouseenter',e=>showTip(e,a));
    row.addEventListener('mouseleave',hideTip);
    wrap.appendChild(row);
  });

  // EMPTY ROW at end for quick add (like Project)
  const emptyRow=document.createElement('div');
  emptyRow.className='trow empty-row';
  emptyRow.style.width=totalColW()+'px';
  VC.forEach((c)=>{
    const ci=COLS.indexOf(c);
    const cell=document.createElement('div');
    cell.className='tcell '+c.cls;
    cell.style.width=colWidths[ci]+'px';
    if(c.key==='_num') cell.textContent=visRows.length+1;
    if(c.edit===true){
      cell.contentEditable='true';
      cell.spellcheck=false;
      cell.dataset.emptyCol=c.key;
      cell.addEventListener('focus',()=>{emptyRow.style.opacity='1';});
      cell.addEventListener('keydown',e=>{
        if(e.key==='Enter'){
          e.preventDefault();
          commitNewRow(emptyRow);
        }
      });
      cell.addEventListener('blur',()=>{
        setTimeout(()=>{
          if(document.activeElement&&emptyRow.contains(document.activeElement)) return;
          const nameCell=emptyRow.querySelector('[data-empty-col="name"]');
          if(nameCell&&nameCell.textContent.trim()){
            commitNewRow(emptyRow);
          }
        },100);
      });
    }
    emptyRow.appendChild(cell);
  });
  wrap.appendChild(emptyRow);

  // More empty rows for visual
  for(let e=0;e<20;e++){
    const er=document.createElement('div');
    er.className='trow empty-row';
    er.style.width=totalColW()+'px';
    er.style.opacity='.15';
    VC.forEach((c)=>{
      const ci=COLS.indexOf(c);
      const cell=document.createElement('div');
      cell.className='tcell '+c.cls;
      cell.style.width=colWidths[ci]+'px';
      if(c.key==='_num') cell.textContent=visRows.length+2+e;
      er.appendChild(cell);
    });
    er.addEventListener('click',()=>{
      const firstEmpty=wrap.querySelector('.empty-row:not([style*="opacity: 0.15"]) [data-empty-col="name"]')||wrap.querySelector('.empty-row [data-empty-col="name"]');
      if(firstEmpty) firstEmpty.focus();
    });
    wrap.appendChild(er);
  }

  body.appendChild(wrap);
  document.getElementById('gl-wrap').style.width=totalColW()+'px';
}

function commitNewRow(emptyRow){
  pushUndo();
  const a=newActivity('');
  COLS.forEach(c=>{
    if(!c.edit) return;
    const cell=emptyRow.querySelector('[data-empty-col="'+c.key+'"]');
    if(!cell) return;
    const v=cell.textContent.trim();
    if(c.key==='name') a.name=v;
    else if(c.key==='id') a.id=v;
    else if(c.key==='dur'){const n=parseInt(v);if(!isNaN(n)){a.dur=n;if(n===0)a.type='milestone';}}
    else if(c.key==='remDur'){const n=parseInt(v);if(!isNaN(n)) a.remDur=n;}
    else if(c.key==='predStr') a.preds=strToPreds(v);
    else if(c.key==='startDate'){
      const d=parseDate(v);
      if(d){a.constraint='MSO';a.constraintDate=isoDate(d);a.manual=true;}
    }
    else if(c.key==='res'){a.res=v;syncResFromString(a);}
    else if(c.key==='work'){const n=parseFloat(v);if(!isNaN(n)) a.work=Math.max(0,n);}
    else if(c.key==='weight'){const n=parseFloat(String(v).replace('%','').trim());if(!isNaN(n)&&n>0) a.weight=n;}
    else if(c.key==='pct'){const n=parseInt(v);if(!isNaN(n)) a.pct=Math.min(100,Math.max(0,n));}
    else if(c.key==='notes') a.notes=v;
  });
  if(!a.name){return;}
  if(!a.id) a.id=autoId();
  activities.push(a);
  selIdx=activities.length-1;
  calcCPM();
}

function commitEdit(idx, key, val){
  const a=activities[idx]; if(!a) return;
  // Block editing on project row and computed summary fields
  if(a._isProjRow) return;
  if(a.type==='summary' && (key==='work'||key==='pct'||key==='dur')) return;
  pushUndo();
  if(key==='name') a.name=val;
  else if(key==='id'){
    const oldId=a.id;
    a.id=val;
    // Update refs
    activities.forEach(x=>{if(x.preds) x.preds.forEach(p=>{if(p.id===oldId)p.id=val;});});
  }
  else if(key==='dur'){
    const n=parseInt(val);
    if(!isNaN(n)){a.dur=Math.max(0,n);if(n===0)a.type='milestone';else if(a.type==='milestone')a.type='task';}
    a.remDur=null; // reset remaining dur so it auto-calculates
  }
  else if(key==='remDur'){
    const n=parseInt(val);
    if(!isNaN(n)) a.remDur=Math.max(0,n);
  }
  else if(key==='predStr') a.preds=strToPreds(val);
  else if(key==='startDate'){
    const d=parseDate(val);
    if(d){a.constraint='MSO';a.constraintDate=isoDate(d);a.manual=true;}
    else{a.constraint='';a.constraintDate='';a.manual=false;}
  }
  else if(key==='res'){a.res=val;syncResFromString(a);}
  else if(key==='work'){const n=parseFloat(val);if(!isNaN(n)){a.work=Math.max(0,n);distributeWork(a);}}
  else if(key==='weight'){
    const cleaned=String(val).replace('%','').trim();
    const n=parseFloat(cleaned);
    if(!isNaN(n)&&n>0) a.weight=n;
    else a.weight=null;
  }
  else if(key==='pct'){
    a.pct=Math.min(100,Math.max(0,parseInt(val)||0));
    // Auto-calc remaining duration if not manually set
    if(a.remDur===null||a.remDur===undefined){
      a.remDur=Math.round((a.dur||0)*(100-a.pct)/100);
    }
    // Preserve current start: if no constraint, lock current ES as MSO
    if(!a.constraint && a.ES){
      a.constraint='MSO';a.constraintDate=isoDate(a.ES);a.manual=true;
    }
  }
  else if(key==='notes') a.notes=val;
  else if(key.startsWith('txt')) a[key]=val;
  calcCPM();
}

function autoId(){
  let max=0;
  activities.forEach(a=>{const m=a.id.match(/\d+/);if(m) max=Math.max(max,parseInt(m[0]));});
  return 'A'+(Math.ceil((max+10)/10)*10);
}

// 
// ACTIONS
// 
function addNewRow(){
  pushUndo();
  const a=newActivity(autoId());
  a.name='Nueva Actividad';
  if(selIdx>=0) activities.splice(selIdx+1,0,a); else activities.push(a);
  selIdx=selIdx>=0?selIdx+1:activities.length-1;
  calcCPM();
  // Focus name
  setTimeout(()=>{
    const rows=document.querySelectorAll('#gl-body .trow:not(.empty-row)');
    const vi=visRows.findIndex(v=>v._idx===selIdx);
    if(vi>=0&&rows[vi]){
      const nameCol=visCols().findIndex(c=>c.key==='name');
      rows[vi].children[nameCol].focus();
      document.execCommand('selectAll');
    }
  },50);
}

function addMilestone(){
  pushUndo();
  const a=newActivity(autoId());
  a.name='Nuevo Hito';a.type='milestone';a.dur=0;
  if(selIdx>=0) activities.splice(selIdx+1,0,a); else activities.push(a);
  selIdx=selIdx>=0?selIdx+1:activities.length-1;
  calcCPM();
}

function addSummaryRow(){
  pushUndo();
  const a=newActivity(autoId());
  a.name='Nueva Tarea Resumen';a.type='summary';a.dur=0;
  if(selIdx>=0) activities.splice(selIdx+1,0,a); else activities.push(a);
  selIdx=selIdx>=0?selIdx+1:activities.length-1;
  calcCPM();
  setTimeout(()=>{
    const rows=document.querySelectorAll('#gl-body .trow:not(.empty-row)');
    const vi=visRows.findIndex(v=>v._idx===selIdx);
    if(vi>=0&&rows[vi]){
      const nameCol=visCols().findIndex(c=>c.key==='name');
      if(nameCol>=0){rows[vi].children[nameCol].focus();document.execCommand('selectAll');}
    }
  },50);
}

function deleteSelected(){
  if(selIdx<0) return;
  if(activities[selIdx]._isProjRow){alert('No se puede eliminar la fila resumen del proyecto (EDT 0).');return;}
  if(!confirm('¿Eliminar actividad '+activities[selIdx].id+'?')) return;
  pushUndo();
  const delId=activities[selIdx].id;
  activities.splice(selIdx,1);
  activities.forEach(a=>{if(a.preds) a.preds=a.preds.filter(p=>p.id!==delId);});
  if(selIdx>=activities.length) selIdx=activities.length-1;
  calcCPM();
}

function indentRow(dir){
  if(selIdx<0) return;
  if(activities[selIdx]._isProjRow) return;
  pushUndo();
  const a=activities[selIdx];
  const oldLv=a.lv;
  // Can't indent beyond parent's level + 1
  let maxLv=5;
  if(dir>0 && selIdx>0){
    const prev=activities[selIdx-1];
    maxLv=prev.lv+1; // max one level deeper than previous row
  }
  const newLv=Math.max(0,Math.min(maxLv,oldLv+dir));
  if(newLv===oldLv){return;}
  a.lv=newLv;
  // Auto-promote parent to summary when indenting right
  if(dir>0 && newLv>oldLv && selIdx>0){
    for(let j=selIdx-1;j>=0;j--){
      const parent=activities[j];
      if(parent.lv < newLv){
        if(parent.type!=='summary') parent.type='summary';
        break;
      }
    }
  }
  // Auto-demote: if outdenting and no children remain, revert parent to task
  if(dir<0 && newLv<oldLv){
    for(let j=selIdx-1;j>=0;j--){
      const parent=activities[j];
      if(parent.lv < oldLv){
        // Check if parent still has children
        let hasChildren=false;
        for(let k=j+1;k<activities.length;k++){
          if(activities[k].lv<=parent.lv) break;
          if(activities[k].lv>parent.lv){hasChildren=true;break;}
        }
        if(!hasChildren && parent.type==='summary') parent.type='task';
        break;
      }
    }
  }
  calcCPM();
}

function selectRowByIdx(idx){
  selIdx=idx;
  document.querySelectorAll('.trow').forEach(r=>{
    r.classList.toggle('sel',parseInt(r.dataset.idx)===idx);
  });
  updateFormPanel();
}

function prevActivity(){if(selIdx>0){selIdx--;calcCPM();}}
function nextActivity(){if(selIdx<activities.length-1){selIdx++;calcCPM();}}

// 
// FORM PANEL (bottom)
// 
let _acHlIdx={pa:-1,sa:-1}; // autocomplete highlight index
function linkable(a){return a && a.type!=='summary';} // summaries cannot be linked

function switchFormTab(tab){
  document.querySelectorAll('.fv-tab').forEach(t=>t.classList.toggle('active',t.dataset.panel===tab));
  document.querySelectorAll('.fv-panel').forEach(p=>{
    const isActive=p.id==='panel-'+tab;
    p.classList.toggle('active',isActive);
    p.style.display=isActive?(tab==='predsuc'?'flex':'flex'):'none';
  });
}

// === AUTOCOMPLETE for pred/suc ===
function acGetCandidates(prefix){
  const a=selIdx>=0?activities[selIdx]:null;
  if(!a) return [];
  const q=(prefix||'').toLowerCase();
  return activities.filter(x=>{
    if(x.id===a.id) return false;
    if(!linkable(x)) return false;
    if(!q) return true;
    return x.id.toLowerCase().includes(q)||x.name.toLowerCase().includes(q);
  });
}
function acOpen(prefix){
  _acHlIdx[prefix]=-1;
  acFilter(prefix);
  document.getElementById(prefix+'-list').classList.add('open');
}
function acClose(prefix){
  setTimeout(()=>{document.getElementById(prefix+'-list').classList.remove('open');},150);
}
function acFilter(prefix){
  const inp=document.getElementById(prefix+'-id');
  const list=document.getElementById(prefix+'-list');
  const cands=acGetCandidates(inp.value);
  list.innerHTML='';
  _acHlIdx[prefix]=-1;
  if(!cands.length){list.innerHTML='<div class="ac-empty">Sin resultados</div>';return;}
  cands.slice(0,50).forEach((c,i)=>{
    const d=document.createElement('div');d.className='ac-item';
    d.innerHTML=`<span class="ac-id">${c.id}</span><span class="ac-nm">${c.name}</span>`;
    d.addEventListener('mousedown',e=>{e.preventDefault();inp.value=c.id;acClose(prefix);});
    list.appendChild(d);
  });
  if(cands.length>50){list.innerHTML+='<div class="ac-empty">+'+(cands.length-50)+' más…</div>';}
}
function acKey(e,prefix){
  const list=document.getElementById(prefix+'-list');
  const items=list.querySelectorAll('.ac-item');
  if(!items.length) return;
  if(e.key==='ArrowDown'){e.preventDefault();_acHlIdx[prefix]=Math.min(_acHlIdx[prefix]+1,items.length-1);acHighlight(items,_acHlIdx[prefix]);}
  else if(e.key==='ArrowUp'){e.preventDefault();_acHlIdx[prefix]=Math.max(_acHlIdx[prefix]-1,0);acHighlight(items,_acHlIdx[prefix]);}
  else if(e.key==='Enter'){
    e.preventDefault();
    if(_acHlIdx[prefix]>=0&&_acHlIdx[prefix]<items.length){
      document.getElementById(prefix+'-id').value=items[_acHlIdx[prefix]].querySelector('.ac-id').textContent;
    }
    acClose(prefix);
    if(prefix==='pa') addPredFromForm(); else addSucFromForm();
  }
  else if(e.key==='Escape') acClose(prefix);
}
function acHighlight(items,idx){items.forEach((it,i)=>it.classList.toggle('hl',i===idx));if(items[idx])items[idx].scrollIntoView({block:'nearest'});}

function updateFormPanel(){
  const a=selIdx>=0?activities[selIdx]:null;
  document.getElementById('fh-title').textContent=a?a.id+'  '+a.name:'Selecciona una actividad';
  document.getElementById('fh-name').value=a?a.name:'';
  document.getElementById('fh-dur').value=a?(a.dur||0):'';
  document.getElementById('fh-pct').value=a?(a.pct||0):'';
  document.getElementById('fh-type').value=a?(a.type||'task'):'task';
  document.getElementById('fh-start').value=a&&a.ES?isoDate(a.ES):'';
  document.getElementById('fh-end').value=a&&a.EF?isoDate(addDays(a.EF,-1)):'';
  document.getElementById('fh-manual').checked=a?!!a.manual:false;

  // Predecessor list — inline editable (exclude summaries)
  const pl=document.getElementById('pred-list');
  pl.innerHTML='';
  if(a&&a.preds){
    a.preds.forEach((p,pi)=>{
      const pred=activities.find(x=>x.id===p.id);
      const r=document.createElement('div');r.className='fp-row';
      const linkables=activities.filter(x=>x.id!==a.id&&linkable(x));
      const idSel=`<select class="fp-cell-edit fp-cell fp-cell-id" onchange="editPred(${pi},'id',this.value)">${linkables.map(x=>`<option value="${x.id}"${x.id===p.id?' selected':''}>${x.id}</option>`).join('')}</select>`;
      const nameDiv=`<div class="fp-cell fp-cell-name">${pred?pred.name:'???'}</div>`;
      const typeSel=`<select class="fp-cell-edit fp-cell fp-cell-type" onchange="editPred(${pi},'type',this.value)">${['FS','SS','FF','SF'].map(t=>`<option${t===p.type?' selected':''}>${t}</option>`).join('')}</select>`;
      const lagInp=`<input type="number" class="fp-cell-edit fp-cell fp-cell-lag" value="${p.lag||0}" onchange="editPred(${pi},'lag',this.value)" style="width:50px"/>`;
      r.innerHTML=idSel+nameDiv+typeSel+lagInp+`<div class="fp-cell fp-cell-btn"><span style="color:#f87171;cursor:pointer" onclick="removePred(${pi})">&#10005;</span></div>`;
      pl.appendChild(r);
    });
  }

  // Successor list — inline editable (exclude summaries)
  const sl=document.getElementById('suc-list');
  sl.innerHTML='';
  if(a){
    let sucIdx=0;
    activities.forEach(x=>{
      if(!x.preds) return;
      x.preds.forEach((p,pi)=>{
        if(p.id===a.id){
          const si=sucIdx++;
          const r=document.createElement('div');r.className='fp-row';
          const linkables=activities.filter(z=>z.id!==a.id&&linkable(z));
          const idSel=`<select class="fp-cell-edit fp-cell fp-cell-id" onchange="editSuc('${x.id}',${pi},'id',this.value)">${linkables.map(z=>`<option value="${z.id}"${z.id===x.id?' selected':''}>${z.id}</option>`).join('')}</select>`;
          const nameDiv=`<div class="fp-cell fp-cell-name">${x.name}</div>`;
          const typeSel=`<select class="fp-cell-edit fp-cell fp-cell-type" onchange="editSuc('${x.id}',${pi},'type',this.value)">${['FS','SS','FF','SF'].map(t=>`<option${t===p.type?' selected':''}>${t}</option>`).join('')}</select>`;
          const lagInp=`<input type="number" class="fp-cell-edit fp-cell fp-cell-lag" value="${p.lag||0}" onchange="editSuc('${x.id}',${pi},'lag',this.value)" style="width:50px"/>`;
          r.innerHTML=idSel+nameDiv+typeSel+lagInp+`<div class="fp-cell fp-cell-btn"><span style="color:#f87171;cursor:pointer" onclick="removeSuc('${x.id}',${pi})">&#10005;</span></div>`;
          sl.appendChild(r);
        }
      });
    });
  }

  // Clear autocomplete inputs
  document.getElementById('pa-id').value='';
  document.getElementById('sa-id').value='';

  // Resource list
  const rl=document.getElementById('res-list');
  rl.innerHTML='';
  if(a){
    if(!a.resources) a.resources=[];
    a.resources.forEach((res,ri)=>{
      const r=document.createElement('div');r.className='fp-row';
      const poolR=getPoolResource(res.rid);
      const displayName=poolR?poolR.name:(res.name||'???');
      const displayId=res.rid?'R'+res.rid:'';
      r.innerHTML=`<div class="fp-cell fp-cell-id" style="color:#06b6d4">${displayId}</div>`
        +`<div class="fp-cell fp-cell-name">${displayName}</div>`
        +`<input type="number" class="fp-cell-edit fp-cell fp-cell-units" value="${res.units!=null?res.units:100}" min="0" onchange="editResource(${ri},'units',this.value)" style="width:55px"/>`
        +`<input type="number" class="fp-cell-edit fp-cell fp-cell-work" value="${res.work||0}" min="0" step="0.5" onchange="editResource(${ri},'work',this.value)" style="width:60px"/>`
        +`<div class="fp-cell fp-cell-btn"><span style="color:#f87171;cursor:pointer" onclick="removeResource(${ri})">&#10005;</span></div>`;
      rl.appendChild(r);
    });
    // Empty row for inline adding
    const emptyRow=document.createElement('div');emptyRow.className='fp-row fp-row-empty';
    const nameWrap=document.createElement('div');nameWrap.className='fp-cell fp-cell-name';nameWrap.style.position='relative';
    const nameInp=document.createElement('input');nameInp.type='text';nameInp.id='ra-name-input';nameInp.className='fp-cell-edit';
    nameInp.placeholder='Escribir nombre del recurso...';nameInp.autocomplete='off';
    nameInp.style.cssText='width:100%;background:transparent;border:none;color:inherit;outline:none;font-size:inherit';
    const sugBox=document.createElement('div');sugBox.id='ra-suggest';
    sugBox.style.cssText='display:none;position:absolute;left:0;top:100%;z-index:999;background:#1e1e2e;border:1px solid #444;max-height:150px;overflow-y:auto;width:100%;border-radius:4px';
    nameWrap.appendChild(nameInp);nameWrap.appendChild(sugBox);
    const idCell=document.createElement('div');idCell.className='fp-cell fp-cell-id';idCell.style.color='#555';
    const unitsInp=document.createElement('input');unitsInp.type='number';unitsInp.id='ra-units-input';unitsInp.className='fp-cell-edit fp-cell fp-cell-units';
    unitsInp.value='100';unitsInp.min='0';unitsInp.style.width='55px';unitsInp.placeholder='%';
    const workInp=document.createElement('input');workInp.type='number';workInp.id='ra-work-input';workInp.className='fp-cell-edit fp-cell fp-cell-work';
    workInp.value='0';workInp.min='0';workInp.step='0.5';workInp.style.width='60px';workInp.placeholder='hrs';
    const btnCell=document.createElement('div');btnCell.className='fp-cell fp-cell-btn';
    emptyRow.appendChild(idCell);emptyRow.appendChild(nameWrap);emptyRow.appendChild(unitsInp);emptyRow.appendChild(workInp);emptyRow.appendChild(btnCell);
    rl.appendChild(emptyRow);
    // Wire autocomplete + Enter directly on DOM elements
    nameInp.addEventListener('input',function(){
      const q=this.value.trim().toLowerCase();
      if(!q){sugBox.style.display='none';_raSuggestIdx=-1;return;}
      const matches=resourcePool.filter(r=>r.name.toLowerCase().includes(q));
      if(!matches.length){sugBox.style.display='none';_raSuggestIdx=-1;return;}
      sugBox.innerHTML='';
      matches.forEach((pr,mi)=>{
        const d=document.createElement('div');
        d.style.cssText='padding:4px 8px;cursor:pointer;color:#c4b5fd;font-size:12px;';
        d.textContent='R'+pr.rid+' – '+pr.name;
        d.addEventListener('mousedown',e=>{e.preventDefault();nameInp.value=pr.name;sugBox.style.display='none';_raSuggestIdx=-1;});
        d.addEventListener('mouseenter',()=>{_raSuggestIdx=mi;_highlightSuggest(sugBox);});
        sugBox.appendChild(d);
      });
      _raSuggestIdx=-1;sugBox.style.display='block';
    });
    nameInp.addEventListener('keydown',function(e){
      const items=sugBox.children;
      if(e.key==='ArrowDown'){e.preventDefault();_raSuggestIdx=Math.min(_raSuggestIdx+1,items.length-1);_highlightSuggest(sugBox);}
      else if(e.key==='ArrowUp'){e.preventDefault();_raSuggestIdx=Math.max(_raSuggestIdx-1,-1);_highlightSuggest(sugBox);}
      else if(e.key==='Enter'){
        e.preventDefault();
        if(_raSuggestIdx>=0&&items[_raSuggestIdx]){
          const txt=items[_raSuggestIdx].textContent;
          const m=txt.match(/^R(\d+)\s*–\s*(.+)/);
          if(m) nameInp.value=m[2].trim();
        }
        sugBox.style.display='none';_raSuggestIdx=-1;
        addResourceFromForm();
      }
      else if(e.key==='Escape'){sugBox.style.display='none';_raSuggestIdx=-1;}
      else if(e.key==='Tab'&&_raSuggestIdx>=0&&items[_raSuggestIdx]){
        e.preventDefault();
        const txt=items[_raSuggestIdx].textContent;
        const m=txt.match(/^R(\d+)\s*–\s*(.+)/);
        if(m) nameInp.value=m[2].trim();
        sugBox.style.display='none';_raSuggestIdx=-1;
      }
    });
    nameInp.addEventListener('blur',()=>{setTimeout(()=>{sugBox.style.display='none';_raSuggestIdx=-1;},200);});
    // Enter on units/work also adds
    unitsInp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();addResourceFromForm();}});
    workInp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();addResourceFromForm();}});
  }
}

function formFieldChange(key,val){
  if(selIdx<0) return;
  pushUndo();
  const a=activities[selIdx];
  if(key==='name') a.name=val;
  else if(key==='dur'){a.dur=Math.max(0,parseInt(val)||0);if(a.dur===0)a.type='milestone';else if(a.type==='milestone')a.type='task';}
  else if(key==='pct') a.pct=Math.min(100,Math.max(0,parseInt(val)||0));
  else if(key==='type'){a.type=val;if(val==='milestone')a.dur=0;}
  else if(key==='startDate'){
    const d=parseDate(val);
    if(d){a.constraint='MSO';a.constraintDate=isoDate(d);a.manual=true;}
    else{a.constraint='';a.constraintDate='';a.manual=false;}
  }
  else if(key==='manual') a.manual=!!val;
  calcCPM();
}

function addPredFromForm(){
  if(selIdx<0)return;
  const pid=document.getElementById('pa-id').value.trim();
  const type=document.getElementById('pa-type').value;
  const lag=parseInt(document.getElementById('pa-lag').value)||0;
  if(!pid){alert('Selecciona una actividad');return;}
  const predAct=activities.find(x=>x.id===pid);
  if(!predAct){alert('ID "'+pid+'" no existe');return;}
  if(predAct.type==='summary'){alert('No se puede vincular con actividades Resumen');return;}
  const a=activities[selIdx];
  if(a.type==='summary'){alert('Las actividades Resumen no pueden tener predecesoras');return;}
  pushUndo();
  if(!a.preds) a.preds=[];
  a.preds=a.preds.filter(p=>p.id!==pid);
  a.preds.push({id:pid,type,lag});
  document.getElementById('pa-id').value='';
  document.getElementById('pa-lag').value='0';
  calcCPM();
}
function addSucFromForm(){
  if(selIdx<0)return;
  const sid=document.getElementById('sa-id').value.trim();
  const type=document.getElementById('sa-type').value;
  const lag=parseInt(document.getElementById('sa-lag').value)||0;
  if(!sid){alert('Selecciona una actividad');return;}
  const suc=activities.find(x=>x.id===sid);
  if(!suc){alert('ID "'+sid+'" no existe');return;}
  if(suc.type==='summary'){alert('No se puede vincular con actividades Resumen');return;}
  const a=activities[selIdx];
  if(a.type==='summary'){alert('Las actividades Resumen no pueden tener sucesoras');return;}
  pushUndo();
  if(!suc.preds) suc.preds=[];
  suc.preds=suc.preds.filter(p=>p.id!==activities[selIdx].id);
  suc.preds.push({id:activities[selIdx].id,type,lag});
  document.getElementById('sa-id').value='';
  document.getElementById('sa-lag').value='0';
  calcCPM();
}
function removePred(pi){
  if(selIdx<0)return;
  pushUndo();
  activities[selIdx].preds.splice(pi,1);
  calcCPM();
}
function removeSuc(sucId,pi){
  pushUndo();
  const s=activities.find(x=>x.id===sucId);
  if(s&&s.preds) s.preds.splice(pi,1);
  calcCPM();
}

// 
// INLINE EDIT PRED/SUC
// 
function editPred(pi,field,val){
  if(selIdx<0)return;
  pushUndo();
  const a=activities[selIdx];
  if(!a.preds||!a.preds[pi])return;
  if(field==='id') a.preds[pi].id=val;
  else if(field==='type') a.preds[pi].type=val;
  else if(field==='lag') a.preds[pi].lag=parseInt(val)||0;
  calcCPM();
}
function editSuc(sucId,pi,field,val){
  pushUndo();
  const suc=activities.find(x=>x.id===sucId);
  if(!suc||!suc.preds||!suc.preds[pi])return;
  if(field==='type') suc.preds[pi].type=val;
  else if(field==='lag') suc.preds[pi].lag=parseInt(val)||0;
  else if(field==='id'){
    // Changing which activity is the successor
    const oldPred=suc.preds.splice(pi,1)[0];
    const newSuc=activities.find(x=>x.id===val);
    if(newSuc){
      if(!newSuc.preds) newSuc.preds=[];
      newSuc.preds.push({id:activities[selIdx].id,type:oldPred.type,lag:oldPred.lag});
    }
  }
  calcCPM();
}

// 
// RESOURCE MANAGEMENT
// 
let _raSuggestIdx=-1; // autocomplete highlight index
function _highlightSuggest(box){
  if(!box) return;
  Array.from(box.children).forEach((d,i)=>{d.style.background=i===_raSuggestIdx?'#334155':'transparent';});
}
function addResourceFromForm(){
  if(selIdx<0)return;
  const inp=document.getElementById('ra-name-input');
  const name=inp?inp.value.trim():'';
  if(!name) return;
  const units=parseInt(document.getElementById('ra-units-input').value)||100;
  const work=parseFloat(document.getElementById('ra-work-input').value)||0;
  // Find or create pool resource by name
  let poolR=resourcePool.find(r=>r.name.toLowerCase()===name.toLowerCase());
  if(!poolR){
    // Auto-create in pool
    poolR=newPoolResource();
    poolR.name=name;
    poolR.initials=name.split(' ').map(w=>w[0]||'').join('').toUpperCase().substring(0,3);
    resourcePool.push(poolR);
  }
  const a=activities[selIdx];
  if(!a.resources) a.resources=[];
  if(a.resources.find(r=>r.rid===poolR.rid)){alert('Este recurso ya está asignado a la actividad');return;}
  pushUndo();
  a.resources.push({rid:poolR.rid, name:poolR.name, units, work});
  a.work=a.resources.reduce((s,r)=>s+(r.work||0),0);
  deriveResString(a);
  calcCPM();
}
function deriveResString(a){
  if(!a.resources||!a.resources.length){a.res='';return;}
  a.res=a.resources.map(r=>{const pr=getPoolResource(r.rid);return pr?pr.name:(r.name||'?');}).join('; ');
}
function distributeWork(a){
  // Distribute a.work proportionally among a.resources based on their units
  if(!a.resources||!a.resources.length||!a.work) return;
  const totalUnits=a.resources.reduce((s,r)=>s+(r.units||0),0);
  if(totalUnits<=0) return;
  let distributed=0;
  a.resources.forEach((r,i)=>{
    if(i===a.resources.length-1){
      // Last resource gets remainder to avoid rounding errors
      r.work=Math.round((a.work-distributed)*100)/100;
    } else {
      r.work=Math.round(a.work*(r.units||0)/totalUnits*100)/100;
      distributed+=r.work;
    }
  });
}
function syncResFromString(a){
  // Parse a.res text (names separated by ; or ,) into a.resources[], auto-creating pool entries
  const raw=a.res||'';
  const names=raw.split(/[;,]/).map(s=>s.trim()).filter(Boolean);
  if(!names.length){a.resources=[];a.work=0;return;}
  const prevWork=a.work||0;
  const newRes=[];
  names.forEach(name=>{
    // Find existing pool resource by name (case-insensitive)
    let poolR=resourcePool.find(r=>r.name.toLowerCase()===name.toLowerCase());
    if(!poolR){
      // Auto-create in pool
      poolR=newPoolResource();
      poolR.name=name;
      poolR.initials=name.split(' ').map(w=>w[0]||'').join('').toUpperCase().substring(0,3);
      resourcePool.push(poolR);
    }
    // Check if this activity already had this resource (preserve units/work)
    const existing=a.resources?a.resources.find(r=>r.rid===poolR.rid):null;
    newRes.push({rid:poolR.rid, name:poolR.name, units:existing?existing.units:100, work:existing?existing.work:0});
  });
  a.resources=newRes;
  // If activity had work but new resources have 0, distribute it
  const resWorkSum=a.resources.reduce((s,r)=>s+(r.work||0),0);
  if(prevWork>0&&resWorkSum===0){
    a.work=prevWork;
    distributeWork(a);
  } else {
    a.work=a.resources.reduce((s,r)=>s+(r.work||0),0);
  }
  deriveResString(a);
}
function editResource(ri,field,val){
  if(selIdx<0)return;
  pushUndo();
  const a=activities[selIdx];
  if(!a.resources||!a.resources[ri])return;
  if(field==='rid'){
    const newRid=parseInt(val)||0;
    const pr=getPoolResource(newRid);
    a.resources[ri].rid=newRid;
    a.resources[ri].name=pr?pr.name:'';
  }
  else if(field==='units') a.resources[ri].units=parseInt(val)||0;
  else if(field==='work') a.resources[ri].work=parseFloat(val)||0;
  a.work=a.resources.reduce((s,r)=>s+(r.work||0),0);
  deriveResString(a);
  calcCPM();
}
function removeResource(ri){
  if(selIdx<0)return;
  pushUndo();
  const a=activities[selIdx];
  if(!a.resources) return;
  a.resources.splice(ri,1);
  a.work=a.resources.reduce((s,r)=>s+(r.work||0),0);
  deriveResString(a);
  calcCPM();
}

// 
// ACTIVITY DETAIL MODAL
// 
let actModalId=null;
function showActModal(id){
  const aId=id||( selIdx>=0?activities[selIdx].id:null);
  if(!aId)return;
  const a=activities.find(x=>x.id===aId);
  if(!a)return;
  actModalId=a.id;
  const badge=document.getElementById('am-badge');
  if(a._isProjRow){badge.textContent='PROYECTO';badge.style.background='#312e81';badge.style.color='#c4b5fd';}
  else if(a.type==='milestone'){badge.textContent='HITO';badge.style.background='#78350f';badge.style.color='#fde68a';}
  else if(a.type==='summary'){badge.textContent='RESUMEN';badge.style.background='#312e81';badge.style.color='#c4b5fd';}
  else{badge.textContent='TAREA';badge.style.background='#1e3a5f';badge.style.color='#93c5fd';}
  document.getElementById('am-id').value=a.id;
  document.getElementById('am-lv').value=a.lv;
  document.getElementById('am-name').value=a.name||'';
  document.getElementById('am-type').value=a.type||'task';
  document.getElementById('am-dur').value=a.dur||0;
  document.getElementById('am-remdur').value=a.remDur!=null?a.remDur:Math.round((a.dur||0)*(100-(a.pct||0))/100);
  document.getElementById('am-cal').value=a.cal||defCal;
  document.getElementById('am-pct').value=a.pct||0;
  document.getElementById('am-res').value=a.res||'';
  document.getElementById('am-work').value=a.work||0;
  document.getElementById('am-weight').value=(a.weight!=null&&a.weight>0)?a.weight:'';
  document.getElementById('am-constraint').value=a.constraint||'';
  document.getElementById('am-cdate').value=a.constraintDate||'';
  document.getElementById('am-es').value=a.ES?fmt(a.ES)+' ('+isoDate(a.ES)+')':'';
  document.getElementById('am-ef').value=a.EF?fmt(addDays(a.EF,-1))+' ('+isoDate(addDays(a.EF,-1))+')':'';
  document.getElementById('am-tf').value=a.crit?'0 — RUTA CRÍTICA':(a.TF!=null?a.TF+' días':'');
  // Baseline
  document.getElementById('am-bldur').value=a.blDur!=null?a.blDur+' días':'';
  document.getElementById('am-bles').value=a.blES?fmt(a.blES)+' ('+isoDate(a.blES)+')':'';
  document.getElementById('am-blef').value=a.blEF?fmt(addDays(a.blEF,-1))+' ('+isoDate(addDays(a.blEF,-1))+')':'';
  document.getElementById('am-notes').value=a.notes||'';
  document.getElementById('act-modal-overlay').classList.add('open');
}
function closeActModal(){document.getElementById('act-modal-overlay').classList.remove('open');actModalId=null;}
function saveActModal(){
  if(!actModalId)return;
  const a=activities.find(x=>x.id===actModalId);
  if(!a)return;
  if(a._isProjRow){closeActModal();return;} // project row is read-only
  pushUndo();
  a.lv=parseInt(document.getElementById('am-lv').value);
  a.name=document.getElementById('am-name').value.trim();
  const newType=document.getElementById('am-type').value;
  a.type=newType;
  if(newType==='milestone') a.dur=0;
  else a.dur=Math.max(0,parseInt(document.getElementById('am-dur').value)||0);
  a.remDur=Math.max(0,parseInt(document.getElementById('am-remdur').value)||0);
  a.cal=parseInt(document.getElementById('am-cal').value)||defCal;
  a.pct=Math.min(100,Math.max(0,parseInt(document.getElementById('am-pct').value)||0));
  a.res=document.getElementById('am-res').value.trim();
  syncResFromString(a);
  a.work=Math.max(0,parseFloat(document.getElementById('am-work').value)||0);
  distributeWork(a);
  const wVal=parseFloat(document.getElementById('am-weight').value);
  a.weight=(wVal>0)?wVal:null;
  a.constraint=document.getElementById('am-constraint').value;
  a.constraintDate=document.getElementById('am-cdate').value;
  a.notes=document.getElementById('am-notes').value.trim();
  // If type changed to summary, promote parent logic
  if(newType==='summary' && a.lv>0){
    a.lv=Math.min(a.lv,1);
  }
  closeActModal();
  calcCPM();
}
function deleteFromModal(){
  if(!actModalId)return;
  const da=activities.find(x=>x.id===actModalId);
  if(da&&da._isProjRow){alert('No se puede eliminar la fila resumen del proyecto.');return;}
  if(!confirm('¿Eliminar actividad '+actModalId+'?'))return;
  pushUndo();
  activities=activities.filter(x=>x.id!==actModalId);
  activities.forEach(x=>{if(x.preds) x.preds=x.preds.filter(p=>p.id!==actModalId);});
  if(selIdx>=activities.length) selIdx=activities.length-1;
  closeActModal();
  calcCPM();
}

// 
// CANVAS HEADER
// 
function drawHeader(){
  const t=th();
  const c=document.getElementById('hdrCanvas');
  const W=totalDays*PX;
  c.width=W;c.height=HDR_H;c.style.width=W+'px';c.style.height=HDR_H+'px';
  const ctx=c.getContext('2d');ctx.clearRect(0,0,W,HDR_H);
  let cur=new Date(projStart);const end=addDays(projStart,totalDays);
  while(cur<end){
    const x=dayDiff(projStart,cur)*PX;
    const nm=new Date(cur.getFullYear(),cur.getMonth()+1,1);
    const w=Math.min(dayDiff(cur,nm)*PX,W-x);
    ctx.fillStyle=t.hdrTopBg;ctx.fillRect(x,0,w,17);
    ctx.strokeStyle=t.hdrTopBorder;ctx.strokeRect(x,0,w,17);
    ctx.fillStyle=t.hdrTopText;ctx.font='bold 10px Segoe UI';
    const lbl=cur.toLocaleDateString('es-CL',{month:'short',year:'2-digit'});
    if(w>24) ctx.fillText(lbl,x+4,12);
    cur=nm;
  }
  cur=new Date(projStart);
  while(cur<end){
    const x=dayDiff(projStart,cur)*PX;
    if(zoom==='month'){
      const nm=new Date(cur.getFullYear(),cur.getMonth()+1,1);const w=dayDiff(cur,nm)*PX;
      ctx.fillStyle=t.hdrBotBg;ctx.fillRect(x,17,w,19);
      ctx.strokeStyle=t.hdrBotBorder;ctx.beginPath();ctx.moveTo(x,17);ctx.lineTo(x,HDR_H);ctx.stroke();
      cur=nm;
    } else if(zoom==='week'){
      const w=7*PX;ctx.fillStyle=t.hdrBotBg;ctx.fillRect(x,17,w,19);
      ctx.strokeStyle=t.hdrBotBorder;ctx.beginPath();ctx.moveTo(x,17);ctx.lineTo(x,HDR_H);ctx.stroke();
      const days=['D','L','M','X','J','V','S'];
      const dd=days[cur.getDay()]+' '+String(cur.getDate()).padStart(2,'0')+'/'+String(cur.getMonth()+1).padStart(2,'0');
      ctx.fillStyle=t.hdrBotText;ctx.font='9px Segoe UI';
      if(PX*7>40) ctx.fillText(dd,x+2,30);
      cur.setDate(cur.getDate()+7);
    } else {
      const isSun=cur.getDay()===0,isSat=cur.getDay()===6;
      ctx.fillStyle=isSun||isSat?t.hdrWeekend:t.hdrBotBg;ctx.fillRect(x,17,PX,19);
      ctx.strokeStyle=t.hdrBotBorder;ctx.beginPath();ctx.moveTo(x,17);ctx.lineTo(x,HDR_H);ctx.stroke();
      const days=['D','L','M','X','J','V','S'];
      ctx.fillStyle=isSun||isSat?(lightMode?'#94a3b8':'#374151'):t.hdrBotText;ctx.font='9px Segoe UI';
      if(PX>=18) ctx.fillText(days[cur.getDay()],x+2,30);
      else if(PX>=14) ctx.fillText(cur.getDate(),x+2,30);
      cur.setDate(cur.getDate()+1);
    }
  }
  const today=new Date();const tx=dayDiff(projStart,today)*PX;
  if(tx>=0&&tx<=W){ctx.fillStyle='#f59e0b';ctx.fillRect(tx,0,2,HDR_H);}
  if(statusDate){
    const sx=dayDiff(projStart,statusDate)*PX;
    if(sx>=0&&sx<=W){ctx.fillStyle='#06b6d4';ctx.fillRect(sx,0,2,HDR_H);}
  }
}

// 
// CANVAS BARS
// 
function drawBars(){
  const t=th();
  const c=document.getElementById('barCanvas');
  const W=totalDays*PX,H=Math.max(visRows.length*ROW_H+20*ROW_H,10);
  c.width=W;c.height=H;c.style.width=W+'px';c.style.height=H+'px';
  document.getElementById('empty-state').style.display=visRows.length?'none':'flex';
  if(!visRows.length) return;
  const ctx=c.getContext('2d');ctx.clearRect(0,0,W,H);
  visRows.forEach((vr,i)=>{
    if(vr._isGroupHeader){ctx.fillStyle=lightMode?'#ede9fe':'#1a1040';ctx.fillRect(0,i*ROW_H,W,ROW_H);ctx.strokeStyle=lightMode?'#818cf8':'#4f46e5';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,i*ROW_H+ROW_H);ctx.lineTo(W,i*ROW_H+ROW_H);ctx.stroke();}
    else{ctx.fillStyle=i%2===0?t.rowEven:t.rowOdd;ctx.fillRect(0,i*ROW_H,W,ROW_H);}
  });
  // Grid
  let cur=new Date(projStart);const end=addDays(projStart,totalDays);
  while(cur<end){
    const x=dayDiff(projStart,cur)*PX;const isM=cur.getDate()===1;
    ctx.strokeStyle=isM?t.gridMonth:t.gridLine;ctx.lineWidth=isM?1:.4;
    ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();
    if(zoom==='month'){cur=new Date(cur.getFullYear(),cur.getMonth()+1,1);}
    else if(zoom==='week') cur.setDate(cur.getDate()+7);
    else cur.setDate(cur.getDate()+1);
  }
  // Today
  const today=new Date();const tx=dayDiff(projStart,today)*PX;
  if(tx>=0&&tx<=W){ctx.fillStyle=t.todayLine;ctx.fillRect(tx,0,2,H);}
  // Status Date line
  if(statusDate){
    const sx=dayDiff(projStart,statusDate)*PX;
    if(sx>=0&&sx<=W){ctx.fillStyle=t.statusLine;ctx.fillRect(sx,0,2,H);}
  }
  // Bars
  visRows.forEach((r,i)=>{
    if(!r.ES) return;
    const y=i*ROW_H;
    const bx=Math.max(0,dayDiff(projStart,r.ES)*PX);
    const efX=r.EF?dayDiff(projStart,r.EF)*PX:bx;
    const bw=Math.max(r.type==='milestone'?0:4,efX-bx);
    const by=y+5,bh=ROW_H-10;
    const color=r.crit?'#ef4444':(r.lv<=1?'#6366f1':'#3b82f6');
    if(r.type==='milestone'){
      const mx=bx,my=y+ROW_H/2,sz=7;
      ctx.save();ctx.translate(mx,my);ctx.rotate(Math.PI/4);
      ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.rect(-sz/2,-sz/2,sz,sz);ctx.fill();
      ctx.strokeStyle='#92400e';ctx.lineWidth=1.5;ctx.stroke();ctx.restore();
      ctx.fillStyle=lightMode?'#92400e':'#fbbf24';ctx.font='bold 9px Segoe UI';
      ctx.fillText(fmt(r.ES),mx+10,my+3.5);
    } else if(r.type==='summary'){
      const sy=y+6, sh=6, brkH=10;
      const sColor=r.crit?'#ef4444':t.summaryBar;
      ctx.fillStyle=sColor;
      ctx.fillRect(bx,sy,Math.max(bw,2),sh);
      ctx.beginPath();ctx.moveTo(bx,sy);ctx.lineTo(bx+6,sy);ctx.lineTo(bx,sy+brkH);ctx.closePath();ctx.fill();
      ctx.beginPath();ctx.moveTo(bx+bw,sy);ctx.lineTo(bx+bw-6,sy);ctx.lineTo(bx+bw,sy+brkH);ctx.closePath();ctx.fill();
      if((r.pct||0)>0){const pw=bw*r.pct/100;ctx.fillStyle='#22c55ecc';ctx.fillRect(bx,sy,pw,sh);}
      if(bw>50){
        ctx.fillStyle=t.barLabelOut;ctx.font='bold 9px Segoe UI';
        const lbl=(r.dur||0)+'d'+(r.pct?' '+r.pct+'%':'');
        if(ctx.measureText(lbl).width<bw-8) ctx.fillText(lbl,bx+5,y+ROW_H/2+9);
      }
    } else {
      const pct=r.pct||0;
      // Main bar with solid border for crispness
      ctx.fillStyle=color;
      if(!lightMode){ctx.shadowColor=color;ctx.shadowBlur=3;}
      rrect(ctx,bx,by,bw,bh,3);ctx.fill();
      if(!lightMode) ctx.shadowBlur=0;
      // Border stroke for definition
      if(lightMode){
        ctx.strokeStyle=r.crit?'#b91c1c':(r.lv<=1?'#4338ca':'#1d4ed8');
        ctx.lineWidth=1;
        rrect(ctx,bx,by,bw,bh,3);ctx.stroke();
      }
      // Progress fill
      if(pct>0 && statusDate && r.ES){
        const sdX=dayDiff(projStart,statusDate)*PX;
        const progressW=Math.min(Math.max(0,sdX-bx),bw);
        if(progressW>0){ctx.fillStyle=lightMode?'#22c55eaa':'#22c55e99';rrect(ctx,bx,by,progressW,bh,3);ctx.fill();}
      } else if(pct>0){
        const pw=bw*pct/100;ctx.fillStyle=lightMode?'#22c55eaa':'#22c55e99';rrect(ctx,bx,by,pw,bh,3);ctx.fill();
      }
      // Gradient sheen
      const g=ctx.createLinearGradient(0,by,0,by+bh);
      g.addColorStop(0,t.gradTop);g.addColorStop(1,t.gradBot);
      ctx.fillStyle=g;rrect(ctx,bx,by,bw,bh,3);ctx.fill();
      // Label
      if(bw>50){
        ctx.fillStyle=t.barLabel;ctx.font=(r.lv<=1?'bold ':'')+'9px Segoe UI';
        const lbl=(r.dur||0)+'d'+(pct?' '+pct+'%':'');
        if(ctx.measureText(lbl).width<bw-8) ctx.fillText(lbl,bx+5,y+ROW_H/2+3.5);
      }
      // Drag handle dots at right edge (visual affordance)
      if(bw>12){
        ctx.fillStyle='rgba(255,255,255,0.45)';
        const hx=bx+bw-4,hy=y+ROW_H/2;
        ctx.beginPath();ctx.arc(hx,hy-3,1.2,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(hx,hy+3,1.2,0,Math.PI*2);ctx.fill();
      }
    }
    // === BASELINE BAR (below main bar) ===
    if(r.blES && r.blEF && r.type!=='milestone'){
      const blBx=Math.max(0,dayDiff(projStart,r.blES)*PX);
      const blEx=dayDiff(projStart,r.blEF)*PX;
      const blBw=Math.max(2,blEx-blBx);
      const blBy=y+ROW_H-6, blBh=4;
      ctx.fillStyle=t.blBar;
      rrect(ctx,blBx,blBy,blBw,blBh,2);ctx.fill();
    } else if(r.blES && r.type==='milestone'){
      const bmx=dayDiff(projStart,r.blES)*PX, bmy=y+ROW_H-4;
      ctx.save();ctx.translate(bmx,bmy);ctx.rotate(Math.PI/4);
      ctx.strokeStyle=t.blDiamond;ctx.lineWidth=1;
      ctx.beginPath();ctx.rect(-3,-3,6,6);ctx.stroke();ctx.restore();
    }
  });

  // === CONNECTION LINES (dependency arrows) ===
  _connLines=[]; // reset for click detection
  const vrById={};
  visRows.forEach((r,i)=>{vrById[r.id]=i;});
  visRows.forEach((r,sucVi)=>{
    if(!r.preds||!r.preds.length) return;
    r.preds.forEach((p,predIdx)=>{
      const predVi=vrById[p.id];
      if(predVi===undefined) return;
      const pred=visRows[predVi];
      if(!pred||!pred.ES||!r.ES) return;
      if(pred.type==='summary'||r.type==='summary') return;
      const isCrit=pred.crit&&r.crit;
      ctx.strokeStyle=isCrit?t.connCrit:t.connLine;
      ctx.fillStyle=isCrit?t.connCrit:t.connLine;
      ctx.lineWidth=1.2;
      const predY=predVi*ROW_H+ROW_H/2;
      const sucY=sucVi*ROW_H+ROW_H/2;
      let sx,sy,ex,ey;
      if(p.type==='FS'){sx=dayDiff(projStart,pred.EF)*PX;sy=predY;ex=dayDiff(projStart,r.ES)*PX;ey=sucY;}
      else if(p.type==='SS'){sx=dayDiff(projStart,pred.ES)*PX;sy=predY;ex=dayDiff(projStart,r.ES)*PX;ey=sucY;}
      else if(p.type==='FF'){sx=dayDiff(projStart,pred.EF)*PX;sy=predY;ex=dayDiff(projStart,r.EF)*PX;ey=sucY;}
      else if(p.type==='SF'){sx=dayDiff(projStart,pred.ES)*PX;sy=predY;ex=dayDiff(projStart,r.EF)*PX;ey=sucY;}
      else{sx=dayDiff(projStart,pred.EF)*PX;sy=predY;ex=dayDiff(projStart,r.ES)*PX;ey=sucY;}
      // Build segments and draw
      const segs=[];
      ctx.beginPath();
      if(p.type==='FS'||p.type==='SF'){
        if(ex>sx+12){
          const bendX=sx+6;
          ctx.moveTo(sx,sy);ctx.lineTo(bendX,sy);ctx.lineTo(bendX,ey);ctx.lineTo(ex,ey);
          segs.push({x1:sx,y1:sy,x2:bendX,y2:sy},{x1:bendX,y1:sy,x2:bendX,y2:ey},{x1:bendX,y1:ey,x2:ex,y2:ey});
        } else {
          const detourY=ey>sy?Math.max(ey,sy)+(ROW_H/2+2):Math.min(ey,sy)-(ROW_H/2+2);
          ctx.moveTo(sx,sy);ctx.lineTo(sx+8,sy);ctx.lineTo(sx+8,detourY);ctx.lineTo(ex-8,detourY);ctx.lineTo(ex-8,ey);ctx.lineTo(ex,ey);
          segs.push({x1:sx,y1:sy,x2:sx+8,y2:sy},{x1:sx+8,y1:sy,x2:sx+8,y2:detourY},{x1:sx+8,y1:detourY,x2:ex-8,y2:detourY},{x1:ex-8,y1:detourY,x2:ex-8,y2:ey},{x1:ex-8,y1:ey,x2:ex,y2:ey});
        }
      } else if(p.type==='SS'){
        const leftX=Math.min(sx,ex)-10;
        ctx.moveTo(sx,sy);ctx.lineTo(leftX,sy);ctx.lineTo(leftX,ey);ctx.lineTo(ex,ey);
        segs.push({x1:sx,y1:sy,x2:leftX,y2:sy},{x1:leftX,y1:sy,x2:leftX,y2:ey},{x1:leftX,y1:ey,x2:ex,y2:ey});
      } else if(p.type==='FF'){
        const rightX=Math.max(sx,ex)+10;
        ctx.moveTo(sx,sy);ctx.lineTo(rightX,sy);ctx.lineTo(rightX,ey);ctx.lineTo(ex,ey);
        segs.push({x1:sx,y1:sy,x2:rightX,y2:sy},{x1:rightX,y1:sy,x2:rightX,y2:ey},{x1:rightX,y1:ey,x2:ex,y2:ey});
      } else {
        ctx.moveTo(sx,sy);ctx.lineTo(sx+6,sy);ctx.lineTo(sx+6,ey);ctx.lineTo(ex,ey);
        segs.push({x1:sx,y1:sy,x2:sx+6,y2:sy},{x1:sx+6,y1:sy,x2:sx+6,y2:ey},{x1:sx+6,y1:ey,x2:ex,y2:ey});
      }
      ctx.stroke();
      // Store for click detection
      _connLines.push({sucId:r.id,predId:p.id,predIdx:predIdx,type:p.type,lag:p.lag||0,segments:segs});
      // Arrowhead
      const aLen=5,aW=3;
      const isLeft=(p.type==='SS'||p.type==='FS');
      if(isLeft){ctx.beginPath();ctx.moveTo(ex,ey);ctx.lineTo(ex-aLen,ey-aW);ctx.lineTo(ex-aLen,ey+aW);ctx.closePath();ctx.fill();}
      else{ctx.beginPath();ctx.moveTo(ex,ey);ctx.lineTo(ex+aLen,ey-aW);ctx.lineTo(ex+aLen,ey+aW);ctx.closePath();ctx.fill();}
    });
  });

  // Selection highlight
  if(selIdx>=0){
    const vi=visRows.findIndex(v=>v._idx===selIdx);
    if(vi>=0){ctx.strokeStyle='#6366f1';ctx.lineWidth=1.5;ctx.strokeRect(0,vi*ROW_H,W,ROW_H);}
  }
}

function rrect(ctx,x,y,w,h,r){
  if(w<0)w=0;if(h<0)h=0;if(w<2*r)r=w/2;if(h<2*r)r=h/2;
  ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w,y+h-r);ctx.arcTo(x+w,y+h,x+w-r,y+h,r);ctx.lineTo(x+r,y+h);ctx.arcTo(x,y+h,x,y+h-r,r);
  ctx.lineTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);ctx.closePath();
}

// 
// REDRAW
// 
function redraw(){
  buildHeader();
  buildRows();
  drawHeader();
  drawBars();
}

// 
// ZOOM
// 
function setZoom(z){
  zoom=z;PX=ZOOM_PX[z];
  ['Day','Week','Month'].forEach(k=>{const b=document.getElementById('b'+k);if(b)b.classList.toggle('act',k.toLowerCase()===z);});
  redraw();
}

// 
// SCROLL SYNC
// 
document.getElementById('gl-body').addEventListener('scroll',function(){document.getElementById('gr-body').scrollTop=this.scrollTop;});
document.getElementById('gr-body').addEventListener('scroll',function(){
  document.getElementById('gl-body').scrollTop=this.scrollTop;
  document.getElementById('gr-header').scrollLeft=this.scrollLeft;
});

function goToday(){
  const x=Math.max(0,dayDiff(projStart,new Date())*PX-300);
  document.getElementById('gr-body').scrollLeft=x;
}

// 
// TOOLTIP
// 
const tip=document.getElementById('tip');
function showTip(e,r){
  if(!r.ES) return;
  const preds=(r.preds||[]).map(p=>`${p.id} ${p.type}${p.lag>0?'+'+p.lag:p.lag<0?p.lag:''}`).join(', ')||'';
  tip.innerHTML=`<b style="color:#f9fafb">${r._outlineNum||''} ${r.id}</b><br>
    <span style="color:#94a3b8">${r.name}</span><br>
    Inicio: <b>${fmt(r.ES)}</b> &nbsp; Fin: <b>${fmt(addDays(r.EF,-1))}</b><br>
    Dur: <b style="color:#7dd3fc">${r.type==='milestone'?'Hito':(r.dur||0)+'d'}</b> &nbsp; Dur.Rest: <b style="color:#7dd3fc">${r.remDur!=null?r.remDur+'d':''}</b> &nbsp; Avance: <b style="color:#6ee7b7">${r.pct||0}%</b><br>
    TF: <b style="color:${r.crit?'#ef4444':'#22c55e'}">${r.crit?'CRÍTICA':r.TF+'d'}</b><br>
    <span style="color:#6b7280">Pred: ${preds}</span>`;
  tip.style.display='block';moveTip(e);
}
function moveTip(e){let x=e.clientX+14,y=e.clientY-10;if(x+310>innerWidth)x=e.clientX-315;if(y+140>innerHeight)y=e.clientY-140;tip.style.left=x+'px';tip.style.top=y+'px';}
function hideTip(){tip.style.display='none';}
document.addEventListener('mousemove',e=>{if(tip.style.display==='block')moveTip(e);});

// Bar canvas tooltip & click & DRAG interactions
// Drag state
let _barDrag=null; // {mode:'move'|'resize'|'link', idx, visIdx, startMX, origES, origDur, origEF, linkFromIdx}
let _barDragPreview=null; // {x,y,w} for live preview or {sx,sy,ex,ey} for link line
let _barHover=null; // {zone:'move'|'resize-r'|'link', visIdx}

function hitTestBar(mx,my){
  // Returns {visIdx, zone} or null
  const scrollTop=document.getElementById('gr-body').scrollTop;
  const vi=Math.floor((my+scrollTop)/ROW_H);
  if(vi<0||vi>=visRows.length) return null;
  const r=visRows[vi];
  if(r._isGroupHeader) return null;
  if(!r.ES||r.type==='summary'||r.type==='milestone'||r._isProjRow) return null;
  const bx=Math.max(0,dayDiff(projStart,r.ES)*PX);
  const efX=r.EF?dayDiff(projStart,r.EF)*PX:bx;
  const bw=Math.max(4,efX-bx);
  // Check if within bar Y range (use absolute row Y)
  const bh=ROW_H-10;
  const barTop=vi*ROW_H+5;
  const barBot=barTop+bh;
  const absY=my+scrollTop;
  if(absY<barTop||absY>barBot) return null;
  // Check X zones: adaptive edge size for short bars
  const EDGE=Math.min(7,Math.max(3,bw*0.25));
  const LINK_ZONE=12;
  // Link zone (beyond bar end)
  if(mx>bx+bw+2&&mx<=bx+bw+LINK_ZONE) return {visIdx:vi,zone:'link'};
  // Right edge resize
  if(mx>=bx+bw-EDGE&&mx<=bx+bw+2) return {visIdx:vi,zone:'resize-r'};
  // Body = move
  if(mx>=bx+EDGE&&mx<bx+bw-EDGE) return {visIdx:vi,zone:'move'};
  // Left edge = also resize (drag left to shrink)
  if(mx>=bx-3&&mx<bx+EDGE) return {visIdx:vi,zone:'resize-r'};
  return null;
}

(function(){
  const canvas=document.getElementById('barCanvas');
  let didDrag=false;
  let _suppressClick=false;

  canvas.addEventListener('mousedown',function(e){
    if(e.button!==0) return;
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left+document.getElementById('gr-body').scrollLeft;
    const my=e.clientY-rect.top;
    const hit=hitTestBar(mx,my);
    if(!hit) return;
    const r=visRows[hit.visIdx];
    const a=activities[r._idx];
    if(!a||a._isProjRow||a.type==='summary') return;
    e.preventDefault();
    didDrag=false;
    selectRowByIdx(r._idx);
    if(hit.zone==='move'){
      _barDrag={mode:'move',idx:r._idx,visIdx:hit.visIdx,startMX:mx,
        origES:new Date(r.ES),origDur:r.dur||0,origEF:r.EF?new Date(r.EF):null};
    } else if(hit.zone==='resize-r'){
      _barDrag={mode:'resize',idx:r._idx,visIdx:hit.visIdx,startMX:mx,
        origES:new Date(r.ES),origDur:r.dur||0,origEF:r.EF?new Date(r.EF):null};
    } else if(hit.zone==='link'){
      _barDrag={mode:'link',idx:r._idx,visIdx:hit.visIdx,startMX:mx,
        origES:new Date(r.ES),origDur:r.dur||0,origEF:r.EF?new Date(r.EF):null,
        linkFromIdx:r._idx};
      const efX=dayDiff(projStart,r.EF)*PX;
      _barDragPreview={sx:efX,sy:hit.visIdx*ROW_H+ROW_H/2,ex:mx,ey:my+document.getElementById('gr-body').scrollTop};
    }
  });

  canvas.addEventListener('mousemove',function(e){
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left+document.getElementById('gr-body').scrollLeft;
    const my=e.clientY-rect.top;

    if(_barDrag){
      didDrag=true;
      hideTip();
      const scrollTop=document.getElementById('gr-body').scrollTop;
      if(_barDrag.mode==='move'){
        const dx=mx-_barDrag.startMX;
        const dayShift=Math.round(dx/PX);
        const newES=addDays(_barDrag.origES,dayShift);
        const bx=dayDiff(projStart,newES)*PX;
        const bw=Math.max(4,(_barDrag.origDur||1)*PX*(CAL_F[activities[_barDrag.idx].cal||defCal]||CAL_F[6]));
        _barDragPreview={x:bx,y:_barDrag.visIdx*ROW_H+5,w:bw,h:ROW_H-10,mode:'move',dateLabel:fmt(newES)};
        drawBars();drawDragOverlay();
      } else if(_barDrag.mode==='resize'){
        const dx=mx-_barDrag.startMX;
        const cal=activities[_barDrag.idx].cal||defCal;
        const f=CAL_F[cal]||CAL_F[6];
        const origBw=Math.max(4,Math.round(_barDrag.origDur*f)*PX);
        const newBw=Math.max(PX,origBw+dx);
        const newCalDays=Math.round(newBw/PX);
        const newDur=Math.max(1,Math.round(newCalDays/f));
        const bx=dayDiff(projStart,_barDrag.origES)*PX;
        _barDragPreview={x:bx,y:_barDrag.visIdx*ROW_H+5,w:newBw,h:ROW_H-10,mode:'resize',durLabel:newDur+'d'};
        drawBars();drawDragOverlay();
      } else if(_barDrag.mode==='link'){
        _barDragPreview.ex=mx;_barDragPreview.ey=my+scrollTop;
        drawBars();drawDragOverlay();
      }
      canvas.style.cursor=_barDrag.mode==='link'?'crosshair':_barDrag.mode==='resize'?'ew-resize':'grabbing';
      return;
    }

    // Hover cursor change
    const hit=hitTestBar(mx,my);
    if(hit){
      if(hit.zone==='move') canvas.style.cursor='grab';
      else if(hit.zone==='resize-r') canvas.style.cursor='ew-resize';
      else if(hit.zone==='link') canvas.style.cursor='crosshair';
      _barHover=hit;
    } else {
      canvas.style.cursor='default';
      _barHover=null;
    }
    // Tooltip
    const scrollTop=document.getElementById('gr-body').scrollTop;
    const i=Math.floor((my+scrollTop)/ROW_H);
    if(i>=0&&i<visRows.length) showTip(e,visRows[i]); else hideTip();
  });

  canvas.addEventListener('mouseup',function(e){
    if(!_barDrag){return;}
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left+document.getElementById('gr-body').scrollLeft;
    const my=e.clientY-rect.top;
    const scrollTop=document.getElementById('gr-body').scrollTop;
    let changed=false;

    if(_barDrag.mode==='move'&&didDrag){
      const dx=mx-_barDrag.startMX;
      const dayShift=Math.round(dx/PX);
      if(dayShift!==0){
        const a=activities[_barDrag.idx];
        pushUndo();
        const newES=addDays(_barDrag.origES,dayShift);
        a.constraint='MSO';a.constraintDate=isoDate(newES);a.manual=true;
        changed=true;
      }
    } else if(_barDrag.mode==='resize'&&didDrag){
      const dx=mx-_barDrag.startMX;
      const cal=activities[_barDrag.idx].cal||defCal;
      const f=CAL_F[cal]||CAL_F[6];
      const origBw=Math.max(4,Math.round(_barDrag.origDur*f)*PX);
      const newBw=Math.max(PX,origBw+dx);
      const newCalDays=Math.round(newBw/PX);
      const newDur=Math.max(1,Math.round(newCalDays/f));
      if(newDur!==_barDrag.origDur){
        const a=activities[_barDrag.idx];
        pushUndo();
        a.dur=newDur;
        a.remDur=null;
        if(newDur===0) a.type='milestone'; else if(a.type==='milestone') a.type='task';
        changed=true;
      }
    } else if(_barDrag.mode==='link'&&didDrag){
      // Find target bar under mouse
      const vi=Math.floor((my+scrollTop)/ROW_H);
      if(vi>=0&&vi<visRows.length){
        const target=visRows[vi];
        const fromA=activities[_barDrag.linkFromIdx];
        const toA=activities[target._idx];
        if(toA&&fromA&&toA!==fromA&&!toA._isProjRow&&toA.type!=='summary'){
          const alreadyLinked=(toA.preds||[]).some(p=>p.id===fromA.id);
          if(!alreadyLinked){
            // Show link modal for type + lag selection
            _pendingLink={fromId:fromA.id,toIdx:target._idx};
            showLinkModal(fromA.id,toA.id);
          }
        }
      }
    }

    _barDrag=null;_barDragPreview=null;
    if(didDrag) _suppressClick=true;
    didDrag=false;
    canvas.style.cursor='default';
    if(changed) calcCPM(); else drawBars();
  });

  canvas.addEventListener('mouseleave',function(){
    hideTip();
    if(_barDrag){
      _barDrag=null;_barDragPreview=null;didDrag=false;
      canvas.style.cursor='default';
      drawBars();
    }
  });

  canvas.addEventListener('click',function(e){
    if(_suppressClick){_suppressClick=false;return;}
    const rect=e.target.getBoundingClientRect();
    const mx=e.clientX-rect.left+document.getElementById('gr-body').scrollLeft;
    const my=e.clientY-rect.top;
    const scrollTop=document.getElementById('gr-body').scrollTop;
    // Check if clicking on a connection line
    const connHit=hitTestConnection(mx,my);
    if(connHit){
      showLinkEditModal(connHit.sucId,connHit.predId,connHit.predIdx,connHit.type,connHit.lag);
      return;
    }
    const i=Math.floor((my+scrollTop)/ROW_H);
    if(i>=0&&i<visRows.length&&!visRows[i]._isGroupHeader) selectRowByIdx(visRows[i]._idx);
  });

  canvas.addEventListener('dblclick',function(e){
    const rect=e.target.getBoundingClientRect();
    const mx=e.clientX-rect.left+document.getElementById('gr-body').scrollLeft;
    const my=e.clientY-rect.top;
    const scrollTop=document.getElementById('gr-body').scrollTop;
    // Don't open modal if double-clicking a connection line
    const connHit=hitTestConnection(mx,my);
    if(connHit) return;
    const i=Math.floor((my+scrollTop)/ROW_H);
    if(i>=0&&i<visRows.length&&!visRows[i]._isGroupHeader){selectRowByIdx(visRows[i]._idx);showActModal();}
  });
})();

// LINK MODAL (type + lag selection after drag-link or edit existing)
let _pendingLink=null; // {fromId, toIdx} for new links
let _editingLink=null; // {sucIdx, predIdx, predId} for editing existing links
function showLinkModal(fromId, toId){
  _editingLink=null;
  document.getElementById('lm-title').innerHTML='&#128279; Nueva Vinculación';
  document.getElementById('lm-from').textContent=fromId;
  document.getElementById('lm-to').textContent=toId;
  document.getElementById('lm-type').value='FS';
  document.getElementById('lm-lag').value='0';
  document.getElementById('lm-delete').style.display='none';
  document.getElementById('link-modal-overlay').style.display='flex';
  setTimeout(()=>document.getElementById('lm-type').focus(),50);
}
function showLinkEditModal(sucId, predId, predIdx, type, lag){
  _pendingLink=null;
  const sucIdx=activities.findIndex(a=>a.id===sucId);
  _editingLink={sucIdx:sucIdx, predIdx:predIdx, predId:predId};
  document.getElementById('lm-title').innerHTML='&#128279; Editar Vinculación';
  document.getElementById('lm-from').textContent=predId;
  document.getElementById('lm-to').textContent=sucId;
  document.getElementById('lm-type').value=type||'FS';
  document.getElementById('lm-lag').value=lag||0;
  document.getElementById('lm-delete').style.display='inline-block';
  document.getElementById('link-modal-overlay').style.display='flex';
  setTimeout(()=>document.getElementById('lm-type').focus(),50);
}
function closeLinkModal(action){
  document.getElementById('link-modal-overlay').style.display='none';
  if(action==='delete' && _editingLink){
    const toA=activities[_editingLink.sucIdx];
    if(toA && toA.preds && toA.preds[_editingLink.predIdx]){
      pushUndo();
      toA.preds.splice(_editingLink.predIdx,1);
      calcCPM();
    }
  } else if(action===true && _editingLink){
    const toA=activities[_editingLink.sucIdx];
    if(toA && toA.preds && toA.preds[_editingLink.predIdx]){
      pushUndo();
      toA.preds[_editingLink.predIdx].type=document.getElementById('lm-type').value||'FS';
      toA.preds[_editingLink.predIdx].lag=parseInt(document.getElementById('lm-lag').value)||0;
      calcCPM();
    }
  } else if(action===true && _pendingLink){
    const toA=activities[_pendingLink.toIdx];
    if(toA){
      pushUndo();
      if(!toA.preds) toA.preds=[];
      const type=document.getElementById('lm-type').value||'FS';
      const lag=parseInt(document.getElementById('lm-lag').value)||0;
      toA.preds.push({id:_pendingLink.fromId, type:type, lag:lag});
      calcCPM();
    }
  }
  _pendingLink=null;
  _editingLink=null;
}
// Close link modal on Escape or overlay click
document.getElementById('link-modal-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('link-modal-overlay'))closeLinkModal(false);});
document.getElementById('lm-lag').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();closeLinkModal(true);}});
document.getElementById('lm-type').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();closeLinkModal(true);}});

// Draw drag overlay (preview ghost bar or link line)
function drawDragOverlay(){
  if(!_barDragPreview) return;
  const c=document.getElementById('barCanvas');
  const ctx=c.getContext('2d');
  if(_barDragPreview.mode==='move'||_barDragPreview.mode==='resize'){
    // Ghost bar preview
    ctx.save();
    ctx.globalAlpha=0.45;
    ctx.fillStyle='#818cf8';
    rrect(ctx,_barDragPreview.x,_barDragPreview.y,_barDragPreview.w,_barDragPreview.h,3);ctx.fill();
    ctx.globalAlpha=1;
    ctx.strokeStyle='#6366f1';ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
    rrect(ctx,_barDragPreview.x,_barDragPreview.y,_barDragPreview.w,_barDragPreview.h,3);ctx.stroke();
    ctx.setLineDash([]);
    // Label
    ctx.fillStyle=lightMode?'#1e293b':'#f1f5f9';ctx.font='bold 10px Segoe UI';
    const lbl=_barDragPreview.dateLabel||_barDragPreview.durLabel||'';
    ctx.fillText(lbl,_barDragPreview.x+_barDragPreview.w+6,_barDragPreview.y+_barDragPreview.h/2+4);
    ctx.restore();
  } else if(_barDrag&&_barDrag.mode==='link'){
    // Link line preview
    ctx.save();
    ctx.strokeStyle='#f59e0b';ctx.lineWidth=2;ctx.setLineDash([5,3]);
    ctx.beginPath();
    ctx.moveTo(_barDragPreview.sx,_barDragPreview.sy);
    ctx.lineTo(_barDragPreview.ex,_barDragPreview.ey);
    ctx.stroke();
    // Arrow at cursor
    const dx=_barDragPreview.ex-_barDragPreview.sx;
    const dy=_barDragPreview.ey-_barDragPreview.sy;
    const len=Math.sqrt(dx*dx+dy*dy);
    if(len>10){
      const ux=dx/len,uy=dy/len;
      ctx.fillStyle='#f59e0b';ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(_barDragPreview.ex,_barDragPreview.ey);
      ctx.lineTo(_barDragPreview.ex-ux*8-uy*4,_barDragPreview.ey-uy*8+ux*4);
      ctx.lineTo(_barDragPreview.ex-ux*8+uy*4,_barDragPreview.ey-uy*8-ux*4);
      ctx.closePath();ctx.fill();
    }
    ctx.setLineDash([]);
    ctx.restore();
  }
}

// 
// COLUMN RESIZE
// 
let crIdx=-1,crX=0,crW=0;
function startColResize(e,ci){crIdx=ci;crX=e.clientX;crW=colWidths[ci];document.body.style.userSelect='none';document.body.style.cursor='col-resize';}
document.addEventListener('mousemove',e=>{if(crIdx<0)return;colWidths[crIdx]=Math.max(20,crW+(e.clientX-crX));redraw();});
document.addEventListener('mouseup',()=>{if(crIdx>=0){crIdx=-1;document.body.style.userSelect='';document.body.style.cursor='';}});

// 
// VERTICAL RESIZE (table | chart)
// 
const vrsz=document.getElementById('gantt-v-resize');
let vr=false,vrX=0,vrW=0;
vrsz.addEventListener('mousedown',e=>{vr=true;vrX=e.clientX;vrW=document.getElementById('gl-wrap').offsetWidth;vrsz.classList.add('rsz');document.body.style.userSelect='none';});
document.addEventListener('mousemove',e=>{if(!vr)return;document.getElementById('gl-wrap').style.width=Math.max(200,Math.min(window.innerWidth-200,vrW+(e.clientX-vrX)))+'px';});
document.addEventListener('mouseup',()=>{vr=false;vrsz.classList.remove('rsz');document.body.style.userSelect='';});

// 
// FORM RESIZE (top | bottom)
// 
const frsz=document.getElementById('form-resize');
let fr=false,frY=0,frH=0;
frsz.addEventListener('mousedown',e=>{fr=true;frY=e.clientY;frH=document.getElementById('form-zone').offsetHeight;frsz.classList.add('rsz');document.body.style.userSelect='none';});
document.addEventListener('mousemove',e=>{if(!fr)return;document.getElementById('form-zone').style.height=Math.max(60,Math.min(window.innerHeight-200,frH-(e.clientY-frY)))+'px';});
document.addEventListener('mouseup',()=>{fr=false;frsz.classList.remove('rsz');document.body.style.userSelect='';});

// 
// PROJECT MODAL
// 
function showProjectModal(){
  document.getElementById('m-name').value=projName;
  document.getElementById('m-start').value=isoDate(projStart);
  document.getElementById('m-status').value=isoDate(statusDate);
  document.getElementById('m-cal').value=defCal;
  document.getElementById('modal-overlay').classList.add('open');
}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');}
function saveProjectModal(){
  projName=document.getElementById('m-name').value||'Mi Proyecto';
  const d=parseDate(document.getElementById('m-start').value);
  if(d) projStart=d;
  const sd=parseDate(document.getElementById('m-status').value);
  if(sd){statusDate=sd;document.getElementById('tb-status-date').value=isoDate(sd);}
  defCal=parseInt(document.getElementById('m-cal').value)||6;
  closeModal();
  calcCPM();
}

// 
// EXPORT / IMPORT
// 
function exportJSON(){
  const data={projStart:isoDate(projStart),projName,defCal,statusDate:isoDate(statusDate),colOrder:colOrder,colLabels:getCustomLabels(),resourcePool:JSON.parse(JSON.stringify(resourcePool)),activities:activities.filter(a=>!a._isProjRow).map(a=>({id:a.id,name:a.name,type:a.type,dur:a.dur,remDur:a.remDur,cal:a.cal,pct:a.pct,preds:a.preds,lv:a.lv,constraint:a.constraint,constraintDate:a.constraintDate,manual:a.manual,res:a.res,work:a.work||0,weight:a.weight,resources:a.resources||[],notes:a.notes,blDur:a.blDur,blES:a.blES?isoDate(a.blES):null,blEF:a.blEF?isoDate(a.blEF):null,txt1:a.txt1||'',txt2:a.txt2||'',txt3:a.txt3||'',txt4:a.txt4||'',txt5:a.txt5||''}))};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gantt_'+projName.replace(/\s+/g,'_')+'.json';a.click();
}
function importJSON(){document.getElementById('jsonFile').click();}
function loadJSON(input){
  const f=input.files[0];if(!f)return;
  const r=new FileReader();r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      if(d.projStart) projStart=parseDate(d.projStart)||projStart;
      if(d.projName) projName=d.projName;
      if(d.defCal) defCal=d.defCal;
      if(d.statusDate){statusDate=parseDate(d.statusDate)||statusDate;document.getElementById('tb-status-date').value=isoDate(statusDate);}
      if(d.colOrder && Array.isArray(d.colOrder) && d.colOrder.length===COLS.length) colOrder=d.colOrder;
      if(d.colLabels) restoreCustomLabels(d.colLabels);
      if(Array.isArray(d.resourcePool)&&d.resourcePool.length){resourcePool=d.resourcePool;_rsNextId=resourcePool.reduce((mx,r)=>Math.max(mx,r.rid||0),0)+1;}else{resourcePool=[];_rsNextId=1;}
      if(d.activities) activities=d.activities.map(a=>{
        const na={...newActivity(), ...a};
        if(a.blES) na.blES=parseDate(a.blES);
        if(a.blEF) na.blEF=parseDate(a.blEF);
        return na;
      });
      // Re-derive resource names from pool after both are loaded
      activities.forEach(a=>{if(a.resources&&a.resources.length) deriveResString(a);});
      renderResourceSheet();
      selIdx=activities.length?0:-1;
      calcCPM();
    }catch(err){alert('Error JSON: '+err.message);}
  };r.readAsText(f);input.value='';
}

function exportCSV(){
  const h='ID,Nombre,Tipo,Duracion,DurRestante,Calendario,Avance%,Predecesoras,Nivel,Restriccion,FechaRestriccion,Recursos,Trabajo,Peso,Manual,Notas,DurLB,InicioLB,FinLB,Recursos_JSON,Texto1,Texto2,Texto3,Texto4,Texto5';
  const q=v=>'"'+String(v||"").replace(/"/g,'""')+'"';
  const rows=activities.filter(a=>!a._isProjRow).map(a=>[
    a.id,q(a.name),a.type,a.dur,a.remDur!=null?a.remDur:'',a.cal||defCal,a.pct||0,
    q(predsToStr(a.preds)),a.lv,a.constraint||'',a.constraintDate||'',
    q(a.res),a.work||0,a.weight!=null?a.weight:'',a.manual?1:0,q(a.notes),
    a.blDur!=null?a.blDur:'',a.blES?isoDate(a.blES):'',a.blEF?isoDate(a.blEF):'',
    q(JSON.stringify(a.resources||[])),q(a.txt1||''),q(a.txt2||''),q(a.txt3||''),q(a.txt4||''),q(a.txt5||'')
  ].join(','));
  const csv=[h,...rows].join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const l=document.createElement('a');l.href=URL.createObjectURL(blob);l.download='gantt_'+projName.replace(/\s+/g,'_')+'.csv';l.click();
}
function importCSV(){document.getElementById('csvFile').click();}
function loadCSV(input){
  const f=input.files[0];if(!f)return;
  const r=new FileReader();r.onload=e=>{
    try{
      const text=e.target.result;
      // Smart CSV parser that handles quoted fields with commas and newlines
      const rows=[];let cur=[];let field='';let inQ=false;
      for(let ci=0;ci<text.length;ci++){
        const ch=text[ci];
        if(inQ){
          if(ch==='"'){if(ci+1<text.length&&text[ci+1]==='"'){field+='"';ci++;}else{inQ=false;}}
          else{field+=ch;}
        } else {
          if(ch==='"'){inQ=true;}
          else if(ch===','){cur.push(field);field='';}
          else if(ch==='\n'||ch==='\r'){if(ch==='\r'&&ci+1<text.length&&text[ci+1]==='\n')ci++;cur.push(field);if(cur.some(c=>c.trim()))rows.push(cur);cur=[];field='';}
          else{field+=ch;}
        }
      }
      if(cur.length||field){cur.push(field);if(cur.some(c=>c.trim()))rows.push(cur);}
      if(rows.length<2){alert('CSV vacío');return;}
      const hdr=rows[0].map(h=>h.trim());
      const col=name=>hdr.indexOf(name);
      const na=[];
      for(let i=1;i<rows.length;i++){
        const c=rows[i];
        const g=(idx)=>idx>=0&&idx<c.length?c[idx].trim():'';
        const id=g(col('ID'));if(!id)continue;
        const a=newActivity(id);
        a.name=g(col('Nombre'));a.type=g(col('Tipo'))||'task';
        a.dur=parseInt(g(col('Duracion')))||0;
        const rd=g(col('DurRestante'));a.remDur=rd!==''?parseInt(rd):null;
        a.cal=parseInt(g(col('Calendario')))||defCal;a.pct=parseInt(g(col('Avance%')))||0;
        a.preds=strToPreds(g(col('Predecesoras')));a.lv=parseInt(g(col('Nivel')))||0;
        a.constraint=g(col('Restriccion'));a.constraintDate=g(col('FechaRestriccion'));
        a.res=g(col('Recursos'));a.work=parseFloat(g(col('Trabajo')))||0;
        const wt=g(col('Peso'));a.weight=wt!==''?parseFloat(wt):null;
        a.manual=g(col('Manual'))==='1';
        a.notes=g(col('Notas'));
        const bld=g(col('DurLB'));a.blDur=bld!==''?parseInt(bld):null;
        const bls=g(col('InicioLB'));a.blES=bls?parseDate(bls):null;
        const ble=g(col('FinLB'));a.blEF=ble?parseDate(ble):null;
        const rj=g(col('Recursos_JSON'));if(rj){try{a.resources=JSON.parse(rj);}catch(ex){a.resources=[];}}
        if(!a.resources||!a.resources.length) syncResFromString(a);
        a.txt1=g(col('Texto1'));a.txt2=g(col('Texto2'));a.txt3=g(col('Texto3'));a.txt4=g(col('Texto4'));a.txt5=g(col('Texto5'));
        na.push(a);
      }
      activities=na;selIdx=na.length?0:-1;calcCPM();
      alert(na.length+' actividades importadas');
    }catch(err){alert('Error CSV: '+err.message);}
  };r.readAsText(f);input.value='';
}

// 
// KEYBOARD SHORTCUTS
// 
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeModal();closeActModal();closeLinkModal(false);}
  // Delete key (when not editing a cell)
  if(e.key==='Delete'&&document.activeElement.contentEditable!=='true'&&!document.querySelector('#modal-overlay.open')&&!document.querySelector('#act-modal-overlay.open')){
    deleteSelected();
  }
  // Insert key
  if(e.key==='Insert'&&document.activeElement.contentEditable!=='true'){
    e.preventDefault();addNewRow();
  }
  // Ctrl+Z undo
  if(e.ctrlKey&&e.key==='z'&&document.activeElement.contentEditable!=='true'){
    e.preventDefault();undoAction();
  }
  // Ctrl+X cut
  if(e.ctrlKey&&e.key==='x'&&document.activeElement.contentEditable!=='true'){
    e.preventDefault();cutActivity();
  }
  // Ctrl+V paste
  if(e.ctrlKey&&e.key==='v'&&document.activeElement.contentEditable!=='true'){
    e.preventDefault();pasteActivity();
  }
  // Ctrl+Up / Ctrl+Down move
  if(e.ctrlKey&&e.key==='ArrowUp'&&document.activeElement.contentEditable!=='true'){
    e.preventDefault();moveRow(-1);
  }
  if(e.ctrlKey&&e.key==='ArrowDown'&&document.activeElement.contentEditable!=='true'){
    e.preventDefault();moveRow(1);
  }
});
document.getElementById('modal-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('modal-overlay'))closeModal();});
document.getElementById('act-modal-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('act-modal-overlay'))closeActModal();});

// 
// COLUMN CONTEXT MENU
// 
function showColContextMenu(e){
  const menu=document.getElementById('col-ctx-menu');
  menu.innerHTML='';
  COLS.forEach((c,i)=>{
    if(c.key==='_num'||c.key==='_info'||c.key==='_mode') return;
    const item=document.createElement('label');
    item.className='ctx-item';
    const cb=document.createElement('input');
    cb.type='checkbox';cb.checked=c.visible;
    cb.addEventListener('change',()=>{
      COLS[i].visible=cb.checked;
      redraw();
    });
    item.appendChild(cb);
    item.appendChild(document.createTextNode(' '+(c.label||c.key)));
    menu.appendChild(item);
  });
  let mx=e.clientX,my=e.clientY;
  if(mx+200>innerWidth) mx=innerWidth-210;
  if(my+300>innerHeight) my=innerHeight-310;
  menu.style.left=mx+'px';
  menu.style.top=my+'px';
  menu.style.display='block';
}
document.addEventListener('click',e=>{
  const menu=document.getElementById('col-ctx-menu');
  if(menu&&menu.style.display==='block'&&!menu.contains(e.target)) menu.style.display='none';
});

// 
// SUPABASE INTEGRATION — Auto-save / Auto-load
// 
const SB_URL='https://sokyvnimjvkfkpvdqssf.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNva3l2bmltanZrZmtwdmRxc3NmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MDQ5MDEsImV4cCI6MjA4NzI4MDkwMX0.VHIJPTkR1olbNJv7pANC4na8iM_LARa7zRMBgLRkbRU';
const _sbClient=supabase.createClient(SB_URL,SB_KEY);
let _sbCurrentProjectId=localStorage.getItem('sb_current_project_id')||null;
let _sbSelectedProjectId=null;
let _sbSaveTimer=null;
let _sbSaving=false;
let _sbLoading=false;

function _sbStatus(msg,color){
  const el=document.getElementById('sb-sync-status');
  if(el){el.textContent=msg;el.style.color=color||'#94a3b8';}
}

// ─── AUTO-SAVE (debounced, called after every calcCPM) ───
function sbAutoSave(){
  if(_sbLoading) return; // skip during load
  if(_sbSaveTimer) clearTimeout(_sbSaveTimer);
  _sbSaveTimer=setTimeout(()=>{ _sbDoSave(); },1500); // 1.5s debounce
}
async function _sbDoSave(){
  if(_sbSaving) return;
  _sbSaving=true;
  _sbStatus('\u23F3 Guardando...','#fbbf24');
  try{
    // 1. Upsert project
    let projId=_sbCurrentProjectId;
    const _projStart=isoDate(projStart)||null;
    const _statusDate=isoDate(statusDate)||null;
    if(projId){
      const {error}=await _sbClient.from('gantt_projects').update({projname:projName,projstart:_projStart,defcal:defCal,statusdate:_statusDate}).eq('id',projId);
      if(error) throw error;
    } else {
      const {data,error}=await _sbClient.from('gantt_projects').insert({projname:projName,projstart:_projStart,defcal:defCal,statusdate:_statusDate}).select().single();
      if(error) throw error;
      projId=data.id;
      _sbCurrentProjectId=projId;
      localStorage.setItem('sb_current_project_id',projId);
    }
    // 2. Delete existing child data (cascade-safe order)
    const {error:d1}=await _sbClient.from('gantt_activity_resources').delete().eq('project_id',projId);
    if(d1) throw d1;
    const {error:d2}=await _sbClient.from('gantt_dependencies').delete().eq('project_id',projId);
    if(d2) throw d2;
    const {error:d3}=await _sbClient.from('gantt_activities').delete().eq('project_id',projId);
    if(d3) throw d3;
    const {error:d4}=await _sbClient.from('gantt_resources').delete().eq('project_id',projId);
    if(d4) throw d4;
    // 3. Insert resources
    let ridMap={};
    if(resourcePool.length){
      const resRows=resourcePool.map(r=>({project_id:projId,rid:r.rid,name:r.name,type:r.type,materiallabel:r.materialLabel,initials:r.initials,resource_group:r.group,maxcapacity:r.maxCapacity,stdrate:r.stdRate,overtimerate:r.overtimeRate,costperuse:r.costPerUse,accrual:r.accrual,calendar:r.calendar,code:r.code}));
      const {data:resData,error:resErr}=await _sbClient.from('gantt_resources').insert(resRows).select();
      if(resErr) throw resErr;
      resData.forEach(r=>{ridMap[r.rid]=r.id;});
    }
    // 4. Insert activities
    const acts=activities.filter(a=>!a._isProjRow);
    let localIdMap={};
    if(acts.length){
      const actRows=acts.map((a,i)=>{
        const cd=a.constraintDate&&a.constraintDate.trim?a.constraintDate.trim():'';
        return {
        project_id:projId,local_id:a.id,sort_order:i,name:a.name||'',type:a.type||'task',
        dur:a.dur!=null?a.dur:0,remdur:a.remDur!=null?a.remDur:null,cal:a.cal||defCal,pct:a.pct||0,notes:a.notes||'',
        res:a.res||'',work:a.work||0,weight:a.weight!=null?a.weight:null,lv:a.lv||0,
        constraint_type:a.constraint||null,constraintdate:cd?cd:null,
        manual:!!a.manual,"ES":a.ES?a.ES.toISOString():null,"EF":a.EF?a.EF.toISOString():null,
        "LS":a.LS?a.LS.toISOString():null,"LF":a.LF?a.LF.toISOString():null,
        "TF":a.TF!=null?a.TF:null,crit:!!a.crit,
        bldur:a.blDur!=null?a.blDur:null,bles:a.blES?a.blES.toISOString():null,blef:a.blEF?a.blEF.toISOString():null,
        txt1:a.txt1||'',txt2:a.txt2||'',txt3:a.txt3||'',txt4:a.txt4||'',txt5:a.txt5||''
      };});
      const {data:actData,error:actErr}=await _sbClient.from('gantt_activities').insert(actRows).select();
      if(actErr) throw actErr;
      actData.forEach(a=>{localIdMap[a.local_id]=a.id;});
      // 5. Dependencies
      const depRows=[];
      acts.forEach(a=>{
        if(!a.preds) return;
        const toUuid=localIdMap[a.id]; if(!toUuid) return;
        a.preds.forEach(p=>{
          const fromUuid=localIdMap[p.id];
          if(fromUuid) depRows.push({project_id:projId,from_activity_id:fromUuid,to_activity_id:toUuid,type:p.type||'FS',lag:p.lag||0});
        });
      });
      if(depRows.length){ const {error:de}=await _sbClient.from('gantt_dependencies').insert(depRows); if(de) throw de; }
      // 6. Activity-resources
      const arRows=[];
      acts.forEach(a=>{
        if(!a.resources) return;
        const actUuid=localIdMap[a.id]; if(!actUuid) return;
        a.resources.forEach(r=>{
          const resUuid=ridMap[r.rid];
          if(resUuid) arRows.push({project_id:projId,activity_id:actUuid,resource_id:resUuid,units:String(r.units||100),work:r.work||0});
        });
      });
      if(arRows.length){ const {error:ae}=await _sbClient.from('gantt_activity_resources').insert(arRows); if(ae) throw ae; }
    }
    _sbStatus('\u2705 Guardado '+new Date().toLocaleTimeString(),'#4ade80');
  }catch(err){
    console.error('Supabase auto-save error:',err);
    const msg=err.message||err.details||err.hint||JSON.stringify(err);
    _sbStatus('\u274c '+msg.substring(0,80),'#f87171');
  }
  _sbSaving=false;
}

// ─── FORCE SAVE (manual button) ───
function sbForceSave(){
  if(_sbSaveTimer) clearTimeout(_sbSaveTimer);
  _sbDoSave();
}

// ─── LOAD PROJECT ───
function sbCloseModal(){ document.getElementById('sb-overlay').style.display='none'; }
function sbShowLoad(){
  _sbSelectedProjectId=null;
  document.getElementById('sb-overlay').style.display='flex';
  sbFetchProjects();
}
async function sbFetchProjects(){
  const statusEl=document.getElementById('sb-load-status');
  const listEl=document.getElementById('sb-project-list');
  statusEl.textContent='Cargando...';statusEl.style.color='#fbbf24';listEl.innerHTML='';
  try{
    const {data,error}=await _sbClient.from('gantt_projects').select('id,projname,projstart,created_at').order('created_at',{ascending:false});
    if(error) throw error;
    if(!data.length){statusEl.textContent='No hay proyectos guardados';statusEl.style.color='#94a3b8';return;}
    statusEl.textContent=data.length+' proyecto(s)';statusEl.style.color='#4ade80';
    data.forEach(p=>{
      const row=document.createElement('div');
      const isCurrent=p.id===_sbCurrentProjectId;
      row.style.cssText='padding:8px 10px;margin:3px 0;background:'+(isCurrent?'#1e3a5f':'#0f172a')+';border:1px solid '+(isCurrent?'#3b82f6':'#334155')+';border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center';
      row.innerHTML='<div><strong style="color:#e2e8f0;font-size:12px">'+(isCurrent?'\u25B6 ':'')+p.projname+'</strong><br/><span style="color:#64748b;font-size:10px">Inicio: '+(p.projstart||'?')+' | '+new Date(p.created_at).toLocaleDateString()+'</span></div>';
      row.addEventListener('click',()=>{
        _sbSelectedProjectId=p.id;
        listEl.querySelectorAll('div').forEach(d=>{d.style.borderColor=d===row?'#6366f1':'#334155';});
        row.style.borderColor='#6366f1';
      });
      listEl.appendChild(row);
    });
  }catch(err){
    statusEl.textContent='\u274c '+(err.message||'Error');statusEl.style.color='#f87171';
  }
}
async function sbLoadProject(){
  if(!_sbSelectedProjectId){alert('Selecciona un proyecto');return;}
  await _sbLoadById(_sbSelectedProjectId);
  sbCloseModal();
}
async function _sbLoadById(pid){
  _sbLoading=true;
  _sbStatus('\u23F3 Cargando...','#fbbf24');
  try{
    const {data:proj,error:pe}=await _sbClient.from('gantt_projects').select('*').eq('id',pid).single();
    if(pe) throw pe;
    projName=proj.projname||'Mi Proyecto';
    projStart=parseDate(proj.projstart)||new Date();
    defCal=proj.defcal||6;
    if(proj.statusdate){statusDate=parseDate(proj.statusdate)||new Date();document.getElementById('tb-status-date').value=isoDate(statusDate);}
    // Resources
    const {data:resData,error:re}=await _sbClient.from('gantt_resources').select('*').eq('project_id',pid).order('rid');
    if(re) throw re;
    resourcePool=resData.map(r=>({rid:r.rid,name:r.name||'',type:r.type||'Trabajo',materialLabel:r.materiallabel||'',initials:r.initials||'',group:r.resource_group||'',maxCapacity:r.maxcapacity||'100%',stdRate:r.stdrate||'0',overtimeRate:r.overtimerate||'0',costPerUse:r.costperuse||'0',accrual:r.accrual||'Prorrateo',calendar:r.calendar||'7d',code:r.code||''}));
    _rsNextId=resourcePool.length?Math.max(...resourcePool.map(r=>r.rid))+1:1;
    const uuidToRid={};resData.forEach(r=>{uuidToRid[r.id]=r.rid;});
    // Activities
    const {data:actData,error:ae}=await _sbClient.from('gantt_activities').select('*').eq('project_id',pid).order('sort_order');
    if(ae) throw ae;
    const uuidToLocalId={};actData.forEach(a=>{uuidToLocalId[a.id]=a.local_id;});
    // Dependencies
    const {data:depData,error:de}=await _sbClient.from('gantt_dependencies').select('*').eq('project_id',pid);
    if(de) throw de;
    const depMap={};
    depData.forEach(d=>{
      const toL=uuidToLocalId[d.to_activity_id],fromL=uuidToLocalId[d.from_activity_id];
      if(!toL||!fromL) return;
      if(!depMap[toL]) depMap[toL]=[];
      depMap[toL].push({id:fromL,type:d.type||'FS',lag:d.lag||0});
    });
    // Activity-resources
    const {data:arData,error:arE}=await _sbClient.from('gantt_activity_resources').select('*').eq('project_id',pid);
    if(arE) throw arE;
    const arMap={};
    arData.forEach(ar=>{
      if(!arMap[ar.activity_id]) arMap[ar.activity_id]=[];
      const rid=uuidToRid[ar.resource_id];
      if(rid!=null) arMap[ar.activity_id].push({rid,units:parseInt(ar.units)||100,work:ar.work||0,name:''});
    });
    // Build activities
    activities=actData.map(a=>{
      const na={...newActivity()};
      na.id=a.local_id;na.name=a.name||'';na.type=a.type||'task';
      na.dur=parseFloat(a.dur)||0;na.remDur=a.remdur!=null?parseFloat(a.remdur):null;
      na.cal=a.cal||defCal;na.pct=parseFloat(a.pct)||0;
      na.notes=a.notes||'';na.res=a.res||'';na.work=parseFloat(a.work)||0;
      na.weight=a.weight!=null?parseFloat(a.weight):null;na.lv=a.lv||0;
      na.constraint=a.constraint_type||'';na.constraintDate=a.constraintdate||'';
      na.manual=!!a.manual;
      na.blDur=a.bldur!=null?parseFloat(a.bldur):null;
      na.blES=a.bles?new Date(a.bles):null;na.blEF=a.blef?new Date(a.blef):null;
      na.txt1=a.txt1||'';na.txt2=a.txt2||'';na.txt3=a.txt3||'';na.txt4=a.txt4||'';na.txt5=a.txt5||'';
      na.preds=depMap[a.local_id]||[];
      const actRes=arMap[a.id]||[];
      actRes.forEach(ar=>{const pr=getPoolResource(ar.rid);if(pr) ar.name=pr.name;});
      na.resources=actRes;
      if(actRes.length) deriveResString(na);
      return na;
    });
    _sbCurrentProjectId=pid;
    localStorage.setItem('sb_current_project_id',pid);
    renderResourceSheet();
    selIdx=activities.length?0:-1;
    _sbStatus('\u2705 Cargado '+new Date().toLocaleTimeString(),'#4ade80');
    calcCPM();
  }catch(err){
    console.error('Supabase load error:',err);
    _sbStatus('\u274c Error al cargar','#f87171');
  }
  _sbLoading=false;
}
async function sbDeleteProject(){
  if(!_sbSelectedProjectId){alert('Selecciona un proyecto');return;}
  if(!confirm('\u00bfEliminar este proyecto? No se puede deshacer.')) return;
  try{
    await _sbClient.from('gantt_projects').delete().eq('id',_sbSelectedProjectId);
    if(_sbCurrentProjectId===_sbSelectedProjectId){_sbCurrentProjectId=null;localStorage.removeItem('sb_current_project_id');}
    _sbSelectedProjectId=null;
    sbFetchProjects();
  }catch(err){alert('Error: '+err.message);}
}
document.getElementById('sb-overlay').addEventListener('click',e=>{if(e.target.id==='sb-overlay')sbCloseModal();});

// 
// INIT — Auto-load from Supabase if project exists, otherwise start fresh
// 
async function _initApp(){
  projStart=new Date();projStart.setHours(0,0,0,0);
  const dow=projStart.getDay();if(dow!==1)projStart.setDate(projStart.getDate()-((dow+6)%7));
  document.getElementById('tb-status-date').value=isoDate(statusDate);
  if(_sbCurrentProjectId){
    try{
      await _sbLoadById(_sbCurrentProjectId);
    }catch(e){
      console.warn('Could not auto-load from Supabase, starting fresh',e);
      calcCPM();
    }
  } else {
    calcCPM();
  }
}
_initApp();
</script>
</body>
</html>
